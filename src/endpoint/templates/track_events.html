<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Event Lifecycle</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-deep: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-primary: #38bdf8;
            --accent-success: #2dd4bf;
            --accent-warning: #fbbf24;
            --accent-danger: #f87171;
            --accent-purple: #a78bfa;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        /* Header */
        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .page-header h1 {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
        }
        .page-header .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Filter bar */
        .filter-bar {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
        }
        .filter-bar .field { display: flex; flex-direction: column; gap: 0.3rem; }
        .filter-bar label { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }
        .filter-bar input, .filter-bar select {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            font-family: inherit;
        }
        .filter-bar button {
            background: linear-gradient(135deg, var(--accent-primary), #818cf8);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            padding: 0.55rem 1.2rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            transition: transform 0.1s;
        }
        .filter-bar button:hover { transform: translateY(-1px); }

        /* Stats cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 1rem 1.25rem;
            text-align: center;
        }
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1.1;
        }
        .stat-card .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
        }
        .stat-completed .stat-value { color: var(--accent-success); }
        .stat-lost .stat-value { color: var(--accent-danger); }
        .stat-invalid .stat-value { color: var(--accent-warning); }
        .stat-total .stat-value { color: var(--accent-primary); }

        /* Event table */
        .events-table-wrap {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }
        thead th {
            background: rgba(15, 23, 42, 0.6);
            padding: 0.75rem 0.6rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--glass-border);
            white-space: nowrap;
        }
        tbody td {
            padding: 0.6rem;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            vertical-align: top;
        }
        tbody tr:hover { background: rgba(56, 189, 248, 0.05); }

        /* Event type badges */
        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 600;
        }
        .badge-completed { background: rgba(45, 212, 191, 0.15); color: var(--accent-success); }
        .badge-lost { background: rgba(248, 113, 113, 0.15); color: var(--accent-danger); }
        .badge-invalid { background: rgba(251, 191, 36, 0.15); color: var(--accent-warning); }

        /* Direction badges */
        .dir-badge {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.72rem;
            background: rgba(255,255,255,0.06);
            color: var(--text-secondary);
        }

        /* Expandable detail rows */
        .detail-toggle {
            cursor: pointer;
            color: var(--accent-primary);
            font-size: 0.8rem;
            user-select: none;
        }
        .detail-toggle:hover { text-decoration: underline; }
        .detail-row { display: none; }
        .detail-row.open { display: table-row; }
        .detail-cell {
            padding: 0.75rem 1rem;
            background: rgba(15, 23, 42, 0.5);
        }

        /* Detail steps list */
        .steps-list {
            list-style: none;
            padding: 0;
            font-size: 0.78rem;
        }
        .steps-list li {
            padding: 0.35rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            display: flex;
            gap: 0.75rem;
            align-items: baseline;
        }
        .steps-list li:last-child { border-bottom: none; }
        .step-type {
            font-weight: 600;
            min-width: 110px;
            flex-shrink: 0;
        }
        .step-roi_collected .step-type { color: var(--accent-primary); }
        .step-roi_rejected .step-type { color: var(--text-muted); }
        .step-roi_classified .step-type { color: var(--accent-purple); }
        .step-voting_result .step-type { color: var(--accent-success); }
        .step-track_created .step-type { color: var(--accent-primary); }
        .step-track_completed .step-type { color: var(--accent-success); }
        .step-track_lost .step-type { color: var(--accent-danger); }
        .step-track_invalid .step-type { color: var(--accent-warning); }
        .step-info {
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
        }

        /* Coordinates */
        .coord {
            font-family: 'Courier New', monospace;
            font-size: 0.78rem;
            color: var(--text-secondary);
        }

        /* Classification pill */
        .class-pill {
            display: inline-block;
            padding: 0.1rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(167, 139, 250, 0.15);
            color: var(--accent-purple);
        }
        .class-pill.rejected {
            background: rgba(248, 113, 113, 0.15);
            color: var(--accent-danger);
        }

        /* Confidence bar */
        .conf-bar {
            display: inline-block;
            width: 50px;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            vertical-align: middle;
            margin-left: 4px;
        }
        .conf-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        .empty-state i { font-size: 2rem; margin-bottom: 0.75rem; display: block; }

        /* Responsive */
        @media (max-width: 768px) {
            .filter-bar { flex-direction: column; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            table { font-size: 0.75rem; }
        }
    </style>
</head>
<body>
<main>
    <div class="page-header">
        <h1><i class="fa-solid fa-route"></i> Track Event Lifecycle</h1>
        <p class="subtitle">Full lifecycle of every tracked bread bag — creation, ROI collection, classification, and outcome</p>
    </div>

    <!-- Filter Bar -->
    <form class="filter-bar" method="get" action="/track-events">
        <div class="field">
            <label for="track_search"><i class="fa-solid fa-search"></i> Track Search</label>
            <input type="text" id="track_search" name="track_search"
                   value="{{ track_search }}" placeholder="T10 or T10,T20 or T10-T20"
                   style="font-family: monospace;">
        </div>
        <div class="field">
            <label for="start_time">Start Time</label>
            <input type="datetime-local" id="start_time" name="start_time"
                   value="{{ meta.start.strftime('%Y-%m-%dT%H:%M') if meta.start else '' }}">
        </div>
        <div class="field">
            <label for="end_time">End Time</label>
            <input type="datetime-local" id="end_time" name="end_time"
                   value="{{ meta.end.strftime('%Y-%m-%dT%H:%M') if meta.end else '' }}">
        </div>
        <div class="field">
            <label for="event_type">Event Type</label>
            <select id="event_type" name="event_type">
                <option value="">All Types</option>
                <option value="track_completed" {{ 'selected' if meta.event_type_filter == 'track_completed' else '' }}>Completed</option>
                <option value="track_lost" {{ 'selected' if meta.event_type_filter == 'track_lost' else '' }}>Lost</option>
                <option value="track_invalid" {{ 'selected' if meta.event_type_filter == 'track_invalid' else '' }}>Invalid</option>
            </select>
        </div>
        <div class="field">
            <label for="classification">Classification</label>
            <select id="classification" name="classification">
                <option value="">All</option>
                {% for cls in filter_options.classifications %}
                <option value="{{ cls }}" {{ 'selected' if meta.classification_filter == cls else '' }}>{{ cls }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="field">
            <label for="min_confidence">Min Confidence</label>
            <input type="number" id="min_confidence" name="min_confidence" min="0" max="1" step="0.1"
                   value="{{ meta.min_confidence_filter or '' }}" placeholder="0.0-1.0">
        </div>
        <div class="field">
            <label for="min_duration">Min Duration (s)</label>
            <input type="number" id="min_duration" name="min_duration" min="0" step="0.1"
                   value="{{ meta.min_duration_filter or '' }}" placeholder="seconds">
        </div>
        <div class="field">
            <label for="entry_type">Entry Type</label>
            <select id="entry_type" name="entry_type">
                <option value="">All</option>
                <option value="bottom_entry" {{ 'selected' if meta.entry_type_filter == 'bottom_entry' else '' }}>Bottom Entry</option>
                <option value="thrown_entry" {{ 'selected' if meta.entry_type_filter == 'thrown_entry' else '' }}>Thrown Entry</option>
                <option value="midway_entry" {{ 'selected' if meta.entry_type_filter == 'midway_entry' else '' }}>Midway Entry</option>
            </select>
        </div>
        <div class="field">
            <label for="exit_direction">Exit Direction</label>
            <select id="exit_direction" name="exit_direction">
                <option value="">All</option>
                <option value="top" {{ 'selected' if meta.exit_direction_filter == 'top' else '' }}>Top</option>
                <option value="bottom" {{ 'selected' if meta.exit_direction_filter == 'bottom' else '' }}>Bottom</option>
                <option value="left" {{ 'selected' if meta.exit_direction_filter == 'left' else '' }}>Left</option>
                <option value="right" {{ 'selected' if meta.exit_direction_filter == 'right' else '' }}>Right</option>
                <option value="timeout" {{ 'selected' if meta.exit_direction_filter == 'timeout' else '' }}>Timeout</option>
            </select>
        </div>
        <button type="submit"><i class="fa-solid fa-filter"></i> Filter</button>
        <a href="/track-events" style="padding: 0.55rem 1.2rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); color: var(--text-primary); text-decoration: none; font-weight: 600; font-size: 0.85rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(56, 189, 248, 0.1)'; this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='var(--glass-border)'">
            <i class="fa-solid fa-redo"></i> Reset
        </a>

        <!-- Advanced Filters Toggle -->
        <div style="width: 100%; margin-top: 0.5rem;">
            <details {% if noise_filtering_active or meta.min_distance_filter or meta.max_distance_filter or meta.min_hits_filter or meta.max_hits_filter or meta.min_frames_filter or meta.has_ghost_recovery_filter or meta.max_duration_filter %}open{% endif %}>
                <summary style="cursor: pointer; color: var(--accent-primary); font-size: 0.85rem; font-weight: 600;">
                    <i class="fa-solid fa-sliders"></i> Advanced Filters
                </summary>
                <div class="filter-bar" style="margin-top: 0.5rem; border: none; padding: 0;">
                    <div class="field">
                        <label for="max_duration">Max Duration (s)</label>
                        <input type="number" id="max_duration" name="max_duration" min="0" step="0.1"
                               value="{{ meta.max_duration_filter or '' }}" placeholder="seconds">
                    </div>
                    <div class="field">
                        <label for="min_distance">Min Distance (px)</label>
                        <input type="number" id="min_distance" name="min_distance" min="0" step="1"
                               value="{{ meta.min_distance_filter or '' }}" placeholder="e.g. 50">
                    </div>
                    <div class="field">
                        <label for="max_distance">Max Distance (px)</label>
                        <input type="number" id="max_distance" name="max_distance" min="0" step="1"
                               value="{{ meta.max_distance_filter or '' }}" placeholder="e.g. 1000">
                    </div>
                    <div class="field">
                        <label for="min_hits">Min Hits</label>
                        <input type="number" id="min_hits" name="min_hits" min="0" step="1"
                               value="{{ meta.min_hits_filter or '' }}" placeholder="e.g. 3">
                    </div>
                    <div class="field">
                        <label for="max_hits">Max Hits</label>
                        <input type="number" id="max_hits" name="max_hits" min="0" step="1"
                               value="{{ meta.max_hits_filter or '' }}" placeholder="e.g. 50">
                    </div>
                    <div class="field">
                        <label for="min_frames">Min Frames</label>
                        <input type="number" id="min_frames" name="min_frames" min="0" step="1"
                               value="{{ meta.min_frames_filter or '' }}" placeholder="e.g. 10">
                    </div>
                    <div class="field">
                        <label for="has_ghost_recovery">Ghost Recovery</label>
                        <select id="has_ghost_recovery" name="has_ghost_recovery">
                            <option value="">All</option>
                            <option value="yes" {{ 'selected' if meta.has_ghost_recovery_filter == 'yes' else '' }}>Yes (Recovered)</option>
                            <option value="no" {{ 'selected' if meta.has_ghost_recovery_filter == 'no' else '' }}>No (Never recovered)</option>
                        </select>
                    </div>
                </div>
            </details>
        </div>
    </form>

    <!-- Stats -->
    {% set completed_count = stats.by_type.get('track_completed', {}).get('count', 0)|int %}
    {% set lost_count = stats.by_type.get('track_lost', {}).get('count', 0)|int %}
    {% set invalid_count = stats.by_type.get('track_invalid', {}).get('count', 0)|int %}
    {% set total_count = stats.get('total', 0)|int %}

    <div class="stats-row">
        <div class="stat-card stat-total">
            <div class="stat-value">{{ total_count }}</div>
            <div class="stat-label">Total Events</div>
        </div>
        <div class="stat-card stat-completed">
            <div class="stat-value">{{ completed_count }}</div>
            <div class="stat-label"><i class="fa-solid fa-check"></i> Completed</div>
        </div>
        <div class="stat-card stat-lost">
            <div class="stat-value">{{ lost_count }}</div>
            <div class="stat-label"><i class="fa-solid fa-ghost"></i> Lost</div>
        </div>
        <div class="stat-card stat-invalid">
            <div class="stat-value">{{ invalid_count }}</div>
            <div class="stat-label"><i class="fa-solid fa-ban"></i> Invalid Path</div>
        </div>
        {% if total_count > 0 %}
        <div class="stat-card">
            <div class="stat-value" style="color: var(--accent-primary);">{{ "%.0f"|format(completed_count / total_count * 100) }}%</div>
            <div class="stat-label">Success Rate</div>
        </div>
        {% endif %}

        <!-- Recovery Stats -->
        {% if stats.recovery_stats and (stats.recovery_stats.get('recovered_tracks') or stats.recovery_stats.get('total_shadows')) %}
        <div class="stat-card">
            <div class="stat-value" style="color: var(--accent-purple);">{{ stats.recovery_stats.get('recovered_tracks', 0)|int }}</div>
            <div class="stat-label"><i class="fa-solid fa-wand-magic-sparkles"></i> Ghost Recovered</div>
        </div>
        {% endif %}
        {% if stats.recovery_stats and stats.recovery_stats.get('ghost_exit_promoted') %}
        <div class="stat-card">
            <div class="stat-value" style="color: #f59e0b;">{{ stats.recovery_stats.get('ghost_exit_promoted', 0)|int }}</div>
            <div class="stat-label"><i class="fa-solid fa-arrow-up-from-bracket"></i> Ghost Near Top / Companion</div>
        </div>
        {% endif %}
    </div>

    <!-- Enhanced Stats Panels -->
    {% if stats.by_classification or stats.duration_histogram or stats.confidence_histogram %}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <!-- Classification Distribution -->
        {% if stats.by_classification|length > 0 %}
        <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 1rem;">
            <h3 style="font-size: 0.85rem; color: var(--accent-primary); margin-bottom: 0.75rem; font-weight: 600;">
                <i class="fa-solid fa-chart-pie"></i> Top Classifications
            </h3>
            {% for item in stats.by_classification[:5] %}
            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; padding: 0.4rem 0; border-bottom: 1px solid rgba(255,255,255,0.04);">
                <span style="color: var(--text-secondary);">{{ item.classification }}</span>
                <span style="color: var(--text-primary); font-weight: 600;">{{ item.count }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Duration Histogram -->
        {% if stats.duration_histogram %}
        <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 1rem;">
            <h3 style="font-size: 0.85rem; color: var(--accent-primary); margin-bottom: 0.75rem; font-weight: 600;">
                <i class="fa-solid fa-hourglass-end"></i> Duration Distribution
            </h3>
            {% for bucket, count in stats.duration_histogram.items() %}
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0; font-size: 0.75rem;">
                <span style="min-width: 40px; color: var(--text-secondary);">{{ bucket }}</span>
                <div style="flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden;">
                    {% set max_val = stats.duration_histogram.values()|max %}
                    <div style="height: 100%; width: {{ (count / max_val * 100)|int }}%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-purple));"></div>
                </div>
                <span style="min-width: 30px; text-align: right; color: var(--text-primary); font-weight: 600;">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Confidence Histogram -->
        {% if stats.confidence_histogram %}
        <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 1rem;">
            <h3 style="font-size: 0.85rem; color: var(--accent-primary); margin-bottom: 0.75rem; font-weight: 600;">
                <i class="fa-solid fa-signal"></i> Confidence Distribution
            </h3>
            {% for bucket, count in stats.confidence_histogram.items() %}
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0; font-size: 0.75rem;">
                <span style="min-width: 50px; color: var(--text-secondary);">{{ bucket }}</span>
                <div style="flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden;">
                    {% set max_val = stats.confidence_histogram.values()|max %}
                    <div style="height: 100%; width: {{ (count / max_val * 100)|int }}%; background: linear-gradient(90deg, var(--accent-success), var(--accent-primary));"></div>
                </div>
                <span style="min-width: 30px; text-align: right; color: var(--text-primary); font-weight: 600;">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Noise Filtering Banner -->
    {% if noise_filtering_active and noise_count > 0 %}
    <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.25); border-radius: var(--radius-md); padding: 0.75rem 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
        <span style="color: var(--accent-warning); font-size: 0.85rem;">
            <i class="fa-solid fa-filter-circle-xmark"></i>
            <strong>{{ noise_count }}</strong> noise tracks hidden
            (≤2 hits, or distance &lt;30px, or duration &lt;0.3s)
            — adjust in Advanced Filters
        </span>
        <a href="?show_noise=1{% for k,v in request.query_params.items() if k != 'show_noise' %}&{{ k }}={{ v }}{% endfor %}"
           style="padding: 0.35rem 0.75rem; background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: var(--radius-sm); color: var(--accent-warning); text-decoration: none; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">
            <i class="fa-solid fa-eye"></i> Show All
        </a>
    </div>
    {% endif %}

    <!-- Events Table -->
    {% if events|length == 0 %}
    <div class="empty-state">
        <i class="fa-solid fa-inbox"></i>
        <p>No track events found for this time range.</p>
    </div>
    {% else %}
    <div class="events-table-wrap">
        <table>
            <thead>
                <tr>
                    <th></th>
                    <th>Track ID</th>
                    <th>Type</th>
                    <th>Entry</th>
                    <th>Exit</th>
                    <th>Direction</th>
                    <th>Distance</th>
                    <th>Duration</th>
                    <th>Confidence</th>
                    <th>Classification</th>
                    <th>Snapshot</th>
                    <th>Created</th>
                    <th>Ended</th>
                </tr>
            </thead>
            <tbody>
            {% for ev in events %}
                <tr>
                    <td>
                        {% if ev.details|length > 0 %}
                        <span class="detail-toggle" onclick="toggleDetail({{ ev.track_id }})">
                            <i class="fa-solid fa-chevron-right" id="icon-{{ ev.track_id }}"></i>
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <strong>
                            <a href="/track-events/{{ ev.track_id }}/visualize" target="_blank" style="color: var(--accent-primary); text-decoration: none;" title="View animation">
                                T{{ ev.track_id }} <i class="fa-solid fa-external-link" style="font-size: 0.7rem; opacity: 0.7;"></i>
                            </a>
                        </strong>
                    </td>
                    <td>
                        {% if ev.event_type == 'track_completed' %}
                            <span class="badge badge-completed">Completed</span>
                        {% elif ev.event_type == 'track_lost' %}
                            <span class="badge badge-lost">Lost</span>
                        {% elif ev.event_type == 'track_invalid' %}
                            <span class="badge badge-invalid">Invalid</span>
                        {% else %}
                            <span class="badge">{{ ev.event_type }}</span>
                        {% endif %}
                        {% if ev.total_hits is not none and ev.total_hits <= 2 %}
                            <span style="display:inline-block;padding:0.1rem 0.4rem;border-radius:4px;font-size:0.65rem;font-weight:700;background:rgba(100,116,139,0.2);color:var(--text-muted);margin-left:3px;">Noise</span>
                        {% endif %}
                        {% if ev.ghost_exit_promoted %}
                            {% if ev.event_type == 'track_completed' %}
                            <span style="display:inline-block;padding:0.1rem 0.4rem;border-radius:4px;font-size:0.65rem;font-weight:700;background:rgba(16,185,129,0.15);color:#10b981;margin-left:3px;" title="Ghost companion completed when concurrent track T{{ ev.concurrent_track_count }} exited top — counted">Companion</span>
                            {% else %}
                            <span style="display:inline-block;padding:0.1rem 0.4rem;border-radius:4px;font-size:0.65rem;font-weight:700;background:rgba(245,158,11,0.15);color:#f59e0b;margin-left:3px;" title="Ghost was near top exit with concurrent tracks ({{ ev.concurrent_track_count }}) — lost, not counted">Near Top</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td class="coord">
                        {% if ev.entry_x is not none %}({{ ev.entry_x }}, {{ ev.entry_y }}){% else %}—{% endif %}
                    </td>
                    <td class="coord">
                        {% if ev.exit_x is not none %}({{ ev.exit_x }}, {{ ev.exit_y }}){% else %}—{% endif %}
                    </td>
                    <td>
                        {% if ev.exit_direction %}
                            <span class="dir-badge">{{ ev.exit_direction }}</span>
                        {% else %}—{% endif %}
                    </td>
                    <td class="coord">
                        {% if ev.distance_pixels is not none %}{{ "%.0f"|format(ev.distance_pixels) }}px{% else %}—{% endif %}
                    </td>
                    <td>
                        {% if ev.duration_seconds is not none %}{{ "%.2f"|format(ev.duration_seconds) }}s{% else %}—{% endif %}
                    </td>
                    <td>
                        {% if ev.avg_confidence is not none %}
                            {{ "%.2f"|format(ev.avg_confidence) }}
                            <span class="conf-bar">
                                <span class="conf-bar-fill" style="width: {{ (ev.avg_confidence * 100)|int }}%; background: {% if ev.avg_confidence >= 0.8 %}var(--accent-success){% elif ev.avg_confidence >= 0.5 %}var(--accent-warning){% else %}var(--accent-danger){% endif %};"></span>
                            </span>
                        {% else %}—{% endif %}
                    </td>
                    <td>
                        {% if ev.classification %}
                            <span class="class-pill {{ 'rejected' if ev.classification == 'Rejected' else '' }}">{{ ev.classification }}</span>
                            {% if ev.classification_confidence is not none %}
                                <span style="font-size:0.72rem;color:var(--text-muted)">{{ "%.2f"|format(ev.classification_confidence) }}</span>
                            {% elif ev.event_type == 'track_lost' %}
                                <span style="display:inline-block;padding:0.1rem 0.35rem;border-radius:3px;font-size:0.6rem;font-weight:600;background:rgba(251,191,36,0.15);color:#f59e0b;margin-left:3px;" title="Classification inferred from current batch type">inferred</span>
                            {% endif %}
                        {% else %}—{% endif %}
                    </td>
                    <td>
                        {% if ev.snapshot_path %}
                            <img src="/track-events/snapshot/{{ ev.snapshot_path }}" alt="T{{ ev.track_id }}"
                                 onclick="openSnapshot(this.src, 'T{{ ev.track_id }}')"
                                 style="width:56px;height:auto;border-radius:4px;cursor:zoom-in;border:1px solid rgba(148,163,184,0.2);transition:transform .15s;"
                                 onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                        {% else %}—{% endif %}
                    </td>
                    <td style="font-size:0.75rem;color:var(--text-muted)">{{ ev.created_at[:19] if ev.created_at else '—' }}</td>
                    <td style="font-size:0.75rem;color:var(--text-muted)">{{ ev.timestamp[:19] if ev.timestamp else '—' }}</td>
                </tr>

                <!-- Expandable detail row -->
                {% if ev.details|length > 0 %}
                <tr class="detail-row" id="detail-{{ ev.track_id }}">
                    <td colspan="13" class="detail-cell">
                        <strong style="font-size:0.8rem;color:var(--accent-primary);">
                            <i class="fa-solid fa-list-timeline"></i> Lifecycle Steps ({{ ev.details|length }})
                        </strong>
                        <ul class="steps-list">
                        {% for step in ev.details %}
                            <li class="step-{{ step.step_type }}">
                                <span class="step-type">{{ step.step_type }}</span>
                                <span class="step-info">
                                    {% if step.step_type == 'roi_collected' %}
                                        ROI #{{ step.roi_index if step.roi_index is not none else '?' }}
                                        bbox=({{ step.bbox_x1 }}, {{ step.bbox_y1 }}, {{ step.bbox_x2 }}, {{ step.bbox_y2 }})
                                        {% if step.quality_score is not none %}quality={{ "%.1f"|format(step.quality_score) }}{% endif %}

                                    {% elif step.step_type == 'roi_classified' %}
                                        ROI #{{ step.roi_index if step.roi_index is not none else '?' }}
                                        → <span class="class-pill {{ 'rejected' if step.is_rejected else '' }}">{{ step.class_name or '?' }}</span>
                                        {% if step.confidence is not none %}conf={{ "%.3f"|format(step.confidence) }}{% endif %}

                                    {% elif step.step_type == 'voting_result' %}
                                        → <span class="class-pill">{{ step.class_name or '?' }}</span>
                                        {% if step.confidence is not none %}conf={{ "%.3f"|format(step.confidence) }}{% endif %}
                                        {% if step.valid_votes is not none %}valid_votes={{ step.valid_votes }}{% endif %}

                                    {% elif step.step_type in ('track_completed', 'track_lost', 'track_invalid') %}
                                        {% if step.detail %}{{ step.detail }}{% endif %}

                                    {% else %}
                                        {% if step.detail %}{{ step.detail }}{% endif %}
                                    {% endif %}

                                    <span style="color:var(--text-muted);margin-left:0.5rem;">{{ step.timestamp[:19] if step.timestamp else '' }}</span>
                                </span>
                            </li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Pagination -->
    {% if pagination.total_pages > 1 %}
    <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
        <span style="color: var(--text-secondary); font-size: 0.85rem;">
            Page {{ pagination.page }} of {{ pagination.total_pages }}
            ({{ pagination.total_count }} total)
        </span>
        <div style="display: flex; gap: 0.5rem;">
            {% if pagination.has_prev %}
            <a href="?page=1{% for k,v in request.query_params.items() if k != 'page' %}&{{ k }}={{ v }}{% endfor %}"
               style="padding: 0.5rem 0.75rem; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); color: var(--accent-primary); text-decoration: none; font-size: 0.8rem; transition: all 0.2s;">
                <i class="fa-solid fa-chevron-left"></i> First
            </a>
            <a href="?page={{ pagination.page - 1 }}{% for k,v in request.query_params.items() if k != 'page' %}&{{ k }}={{ v }}{% endfor %}"
               style="padding: 0.5rem 0.75rem; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); color: var(--accent-primary); text-decoration: none; font-size: 0.8rem; transition: all 0.2s;">
                <i class="fa-solid fa-chevron-left"></i> Prev
            </a>
            {% endif %}

            {% if pagination.has_next %}
            <a href="?page={{ pagination.page + 1 }}{% for k,v in request.query_params.items() if k != 'page' %}&{{ k }}={{ v }}{% endfor %}"
               style="padding: 0.5rem 0.75rem; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); color: var(--accent-primary); text-decoration: none; font-size: 0.8rem; transition: all 0.2s;">
                Next <i class="fa-solid fa-chevron-right"></i>
            </a>
            <a href="?page={{ pagination.total_pages }}{% for k,v in request.query_params.items() if k != 'page' %}&{{ k }}={{ v }}{% endfor %}"
               style="padding: 0.5rem 0.75rem; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); color: var(--accent-primary); text-decoration: none; font-size: 0.8rem; transition: all 0.2s;">
                Last <i class="fa-solid fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
        Showing {{ events|length }} events • Data retained for 7 days •
        <a href="/track-events" style="color:var(--accent-primary);">Reset filters</a> •
        <a href="/analytics" style="color:var(--accent-primary);">Counting Analytics</a>
    </div>
</main>

<script>
function toggleDetail(trackId) {
    const row = document.getElementById('detail-' + trackId);
    const icon = document.getElementById('icon-' + trackId);
    if (row) {
        row.classList.toggle('open');
        if (icon) {
            icon.classList.toggle('fa-chevron-right');
            icon.classList.toggle('fa-chevron-down');
        }
    }
}

// Set default times if not set
document.addEventListener('DOMContentLoaded', function() {
    const startInput = document.getElementById('start_time');
    const endInput = document.getElementById('end_time');

    if (!startInput.value) {
        const now = new Date();
        const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        startInput.value = formatDTL(yesterday);
    }
    if (!endInput.value) {
        endInput.value = formatDTL(new Date());
    }

    function formatDTL(d) {
        return d.getFullYear() + '-' +
            String(d.getMonth()+1).padStart(2,'0') + '-' +
            String(d.getDate()).padStart(2,'0') + 'T' +
            String(d.getHours()).padStart(2,'0') + ':' +
            String(d.getMinutes()).padStart(2,'0');
    }

    // Remove empty fields before form submission to keep URLs clean
    document.querySelector('.filter-bar').addEventListener('submit', function(e) {
        const inputs = this.querySelectorAll('input, select');
        inputs.forEach(function(input) {
            if (input.value === '' || input.value === null) {
                input.removeAttribute('name');
            }
        });
    });
});
</script>

<!-- Snapshot Lightbox Modal -->
<div id="snapshotModal" onclick="closeSnapshot(event)" style="
    display:none; position:fixed; inset:0; z-index:9999;
    background:rgba(0,0,0,0.85); backdrop-filter:blur(6px);
    justify-content:center; align-items:center; flex-direction:column; gap:1rem;
    cursor:pointer; animation:fadeIn .2s ease-out;
">
    <div style="position:relative;max-width:90vw;max-height:85vh;" onclick="event.stopPropagation()">
        <button onclick="closeSnapshot()" title="Close" style="
            position:absolute; top:-14px; right:-14px; z-index:10;
            width:36px; height:36px; border-radius:50%; border:none;
            background:rgba(248,113,113,0.9); color:#fff; font-size:1.1rem;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            box-shadow:0 2px 12px rgba(0,0,0,0.4); transition:transform .15s;
        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <img id="snapshotModalImg" src="" alt="" style="
            max-width:90vw; max-height:85vh; border-radius:10px;
            box-shadow:0 8px 40px rgba(0,0,0,0.5);
        ">
    </div>
    <span id="snapshotModalLabel" style="color:#94a3b8;font-size:0.85rem;font-weight:600;"></span>
</div>
<script>
function openSnapshot(src, label) {
    const modal = document.getElementById('snapshotModal');
    document.getElementById('snapshotModalImg').src = src;
    document.getElementById('snapshotModalLabel').textContent = label;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}
function closeSnapshot(e) {
    if (e && e.target && e.target.id !== 'snapshotModal') return;
    const modal = document.getElementById('snapshotModal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
}
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') { document.getElementById('snapshotModal').style.display = 'none'; document.body.style.overflow = ''; }
});
</script>
</body>
</html>
