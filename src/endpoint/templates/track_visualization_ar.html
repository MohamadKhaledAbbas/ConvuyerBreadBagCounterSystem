<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø³Ø§Ø± - Ø±Ù‚Ù… {{ track_id }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/theme.css">
    <style>
        body { direction: ltr; }

        /* Force English numbers */
        .info-value, .time-label, #speedValue {
            font-family: 'Inter', sans-serif !important;
            font-feature-settings: "tnum" 1;
        }

        .container { display: grid; grid-template-columns: 1fr 320px; gap: 1.5rem; }
        .canvas-wrapper { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: 1rem; }
        .canvas-container { position: relative; border-radius: var(--radius-md); overflow: hidden; }
        #bgImage { width: 100%; height: auto; display: block; border-radius: var(--radius-md); opacity: 0.6; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: var(--radius-md); }
        .no-bg-fallback { width: 100%; height: 500px; background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.7)); border-radius: var(--radius-md); }
        .controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-top: 1rem; }
        .progress-wrap { width: 100%; background: rgba(255,255,255,0.05); border-radius: var(--radius-sm); height: 35px; display: flex; align-items: center; padding: 0 1rem; gap: 1rem; margin-top: 1rem; }
        .progress-bar { flex: 1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; cursor: pointer; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-purple)); border-radius: 4px; width: 0%; transition: width 0.05s; }
        .time-label { font-size: 0.8rem; color: var(--text-secondary); font-family: monospace; min-width: 90px; direction: ltr; }
        .sidebar { display: flex; flex-direction: column; gap: 1rem; }
        .info-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 1rem; }
        .info-card h3 { font-size: 0.9rem; color: var(--accent-primary); margin-bottom: 0.75rem; font-weight: 600; }
        .info-row { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 0.4rem 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-secondary); }
        .info-value { color: var(--text-primary); font-weight: 600; font-family: monospace; direction: ltr; }
        .status-badge { padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
        .status-completed { background: rgba(45, 212, 191, 0.15); color: var(--accent-success); }
        .status-lost { background: rgba(248, 113, 113, 0.15); color: var(--accent-danger); }
        .status-invalid { background: rgba(251, 191, 36, 0.15); color: var(--accent-warning); }
        .legend { display: grid; gap: 0.5rem; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; }
        @media (max-width: 1000px) { .container { grid-template-columns: 1fr; } canvas { height: 350px; } }
    </style>
</head>
<body>
<main>
    <a href="/track-events" class="back-home"><i class="fa-solid fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª</a>

    <div class="page-header">
        <h1><i class="fa-solid fa-film"></i> Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø³Ø§Ø± #{{ track_id }}</h1>
        <p class="subtitle">Ø¹Ø±Ø¶ Ù…Ø±Ø¦ÙŠ Ù„Ø±Ø­Ù„Ø© Ø§Ù„ÙƒÙŠØ³ Ø¹Ù„Ù‰ Ø®Ø· Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ù…Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ø±ØµØ¯ Ø­ØªÙ‰ Ø§Ù„Ø®Ø±ÙˆØ¬</p>
    </div>

    <div class="container">
        <div class="canvas-wrapper">
            <div class="canvas-container" id="canvasContainer">
                <img id="bgImage" src="/snapshot/background"
                     alt="Camera View"
                     onerror="this.style.display='none'; document.getElementById('animationCanvas').style.position='relative'; document.getElementById('animationCanvas').style.height='500px';">
                <canvas id="animationCanvas"></canvas>
            </div>

            <div class="controls">
                <button id="playBtn" class="btn btn-primary" onclick="togglePlay()">
                    <i class="fa-solid fa-play"></i> ØªØ´ØºÙŠÙ„
                </button>
                <button class="btn btn-secondary" onclick="resetAnimation()">
                    <i class="fa-solid fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø©
                </button>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <label style="font-size: 0.85rem; color: var(--text-secondary);">Ø³Ø±Ø¹Ø© Ø§Ù„Ø¹Ø±Ø¶:</label>
                    <input type="range" id="speedSlider" min="0.5" max="3" step="0.5" value="1" style="width: 100px;" onchange="updateSpeed(this.value)">
                    <span id="speedValue" style="font-size: 0.85rem; min-width: 30px;">1x</span>
                </div>
            </div>

            <div class="progress-wrap">
                <span class="time-label"><span id="currentTime">0:00</span> / <span id="totalTime">0:00</span></span>
                <div class="progress-bar" id="progressBar" onclick="seekAnimation(event)">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="info-card">
                <h3><i class="fa-solid fa-info-circle"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø±</h3>
                <div class="info-row">
                    <span class="info-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©:</span>
                    <span class="status-badge status-{{ data.summary.event_type.split('_')[1] }}">
                        {% if data.summary.event_type == 'track_completed' %}ØªÙ… Ø¨Ù†Ø¬Ø§Ø­{% elif data.summary.event_type == 'track_lost' %}ÙÙÙ‚Ø¯{% else %}Ù…Ø³Ø§Ø± Ø®Ø§Ø·Ø¦{% endif %}
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ù…Ø¯Ø© Ø§Ù„Ø±Ø­Ù„Ø©:</span>
                    <span class="info-value">{{ "%.2f"|format(data.summary.duration_seconds or 0) }} Ø«Ø§Ù†ÙŠØ©</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©:</span>
                    <span class="info-value">{{ "%.0f"|format(data.summary.distance_pixels or 0) }} Ø¨ÙƒØ³Ù„</span>
                </div>
                {% if data.summary.classification %}
                <div class="info-row">
                    <span class="info-label">Ø§Ù„ØµÙ†Ù:</span>
                    <span class="info-value">{{ name_to_arabic.get(data.summary.classification, data.summary.classification) }}</span>
                </div>
                {% endif %}
            </div>

            <div class="info-card">
                <h3><i class="fa-solid fa-location-dot"></i> Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø§Ø±</h3>
                <div class="info-row">
                    <span class="info-label">Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (X, Y):</span>
                    <span class="info-value">({{ data.summary.entry.x|default(0, true) }}, {{ data.summary.entry.y|default(0, true) }})</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ù†Ù‚Ø·Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ (X, Y):</span>
                    <span class="info-value">({{ data.summary.exit.x|default(0, true) }}, {{ data.summary.exit.y|default(0, true) }})</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø®Ø±ÙˆØ¬:</span>
                    <span class="info-value">{{ data.summary.exit_direction or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø®ÙˆÙ„:</span>
                    <span class="info-value">{{ data.summary.entry_type or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:</span>
                    <span class="info-value">
                        {{ data.position_history|length if data.position_history else 0 }}
                        {% if not data.position_history or data.position_history|length == 0 %}
                        <span style="color: var(--accent-warning); font-size: 0.7rem;">(Ù…ÙÙˆÙ„Ù‘Ø¯)</span>
                        {% else %}
                        <span style="color: var(--accent-success); font-size: 0.7rem;">(Ø­Ù‚ÙŠÙ‚ÙŠ)</span>
                        {% endif %}
                    </span>
                </div>
            </div>

            <div class="info-card">
                <h3><i class="fa-solid fa-palette"></i> Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ù…ÙˆØ²</h3>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(255,255,255,0.3);"></div>
                        <span>Ø®Ù„ÙÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (ØµÙˆØ±Ø© Ø­ÙŠØ©)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fbbf24;"></div>
                        <span>S = Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ù„Ø¯Ø®ÙˆÙ„)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #38bdf8;"></div>
                        <span>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„ÙƒÙŠØ³</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(56, 189, 248, 0.5);"></div>
                        <span>Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø±ÙƒØ©</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2dd4bf;"></div>
                        <span>âœ“ = ØªÙ… Ø¨Ù†Ø¬Ø§Ø­ (Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f87171;"></div>
                        <span>âœ— = ÙÙÙ‚Ø¯ Ø£Ùˆ Ù…Ø³Ø§Ø± Ø®Ø§Ø·Ø¦ (Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©)</span>
                    </div>
                </div>
                <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.75rem; line-height: 1.4;">
                    <i class="fa-solid fa-info-circle"></i>
                    Ø§Ù„Ù…Ø³Ø§Ø± ÙŠÙØ¸Ù‡Ø± Ø­Ø±ÙƒØ© Ø§Ù„ÙƒÙŠØ³ Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©.
                </p>
            </div>
        </div>
    </div>

    {% if data.snapshot_paths and data.snapshot_paths|length > 0 %}
    <!-- Evidence Keyframes Filmstrip -->
    <div style="margin-top: 1.5rem; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: 1.25rem;">
        <h3 style="font-size: 0.95rem; color: var(--accent-danger); margin-bottom: 1rem; font-weight: 600;">
            <i class="fa-solid fa-camera-retro"></i>
            Ù„Ù‚Ø·Ø§Øª Ø§Ù„Ø£Ø¯Ù„Ø©
            <span style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 400; margin-right: 0.5rem;">
                ({{ data.snapshot_paths|length }} Ø¥Ø·Ø§Ø± â€” ÙƒÙ„ ~0.5 Ø«Ø§Ù†ÙŠØ© â€” ØªØºØ·ÙŠØ© {{ "%.1f"|format(data.snapshot_paths|length * 0.5) }} Ø«Ø§Ù†ÙŠØ©)
            </span>
        </h3>
        <div style="display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 0.75rem; scroll-snap-type: x mandatory;">
            {% for snap in data.snapshot_paths %}
            {% set total = data.snapshot_paths|length %}
            {% set time_offset = "%.1f"|format((loop.index - total) * 0.5) %}
            <div style="flex: 0 0 auto; text-align: center; scroll-snap-align: start;">
                <div style="position: relative; border: 2px solid {% if loop.first %}var(--accent-warning){% elif loop.last %}var(--accent-danger){% else %}rgba(148,163,184,0.2){% endif %}; border-radius: var(--radius-md); overflow: hidden; cursor: zoom-in; transition: border-color 0.15s;"
                     onclick="openEvidenceSnapshot('/track-events/snapshot/{{ snap }}', {{ loop.index }}, {{ total }})"
                     onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='{% if loop.first %}var(--accent-warning){% elif loop.last %}var(--accent-danger){% else %}rgba(148,163,184,0.2){% endif %}'">
                    <img src="/track-events/snapshot/{{ snap }}" alt="Ø¥Ø·Ø§Ø± {{ loop.index }}"
                         style="width: 240px; height: auto; display: block;"
                         loading="lazy">
                    <!-- Frame number badge (top-right) -->
                    <div style="position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.75); color: #fff; font-size: 0.65rem; font-weight: 700; padding: 2px 7px; border-radius: 4px; font-family: 'Inter', monospace;">
                        {{ loop.index }}/{{ total }}
                    </div>
                    <!-- Time offset badge (top-left) -->
                    <div style="position: absolute; top: 6px; left: 6px; background: {% if loop.last %}rgba(248,113,113,0.85){% else %}rgba(0,0,0,0.75){% endif %}; color: #fff; font-size: 0.65rem; font-weight: 700; padding: 2px 7px; border-radius: 4px; font-family: 'Inter', monospace;">
                        {{ time_offset }}s
                    </div>
                    <!-- Label badge (bottom) -->
                    {% if loop.first or loop.last %}
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 12px 8px 6px; text-align: center;">
                        <span style="color: {% if loop.first %}#fbbf24{% else %}#f87171{% endif %}; font-size: 0.7rem; font-weight: 700;">
                            {% if loop.first %}ğŸŸ¡ Ø§Ù„Ø£Ù‚Ø¯Ù… â€” Ø§Ù„ÙƒÙŠØ³ Ù…Ø±Ø¦ÙŠ{% elif loop.last %}ğŸ”´ Ù„Ø­Ø¸Ø© Ø§Ù„ÙÙ‚Ø¯Ø§Ù†{% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>
                <span style="display: block; margin-top: 0.35rem; font-size: 0.65rem; color: var(--text-muted); font-family: 'Inter', monospace;">
                    {{ time_offset }}s
                </span>
            </div>
            {% endfor %}
        </div>
        <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
            <div style="flex: 1; height: 3px; background: linear-gradient(90deg, #fbbf24, var(--text-muted) 15%, var(--text-muted) 85%, #f87171); border-radius: 2px; opacity: 0.4;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted); margin-top: 0.25rem;">
            <span>ğŸŸ¡ Ø§Ù„Ø£Ù‚Ø¯Ù… ({{ "%.1f"|format((1 - data.snapshot_paths|length) * 0.5) }}s)</span>
            <span style="color: var(--text-secondary); font-style: italic;">â† Ø§Ø³Ø­Ø¨ Ù„Ù„ØªÙ…Ø±ÙŠØ± â†’</span>
            <span>ğŸ”´ Ù„Ø­Ø¸Ø© Ø§Ù„ÙÙ‚Ø¯Ø§Ù† (0.0s)</span>
        </div>
        <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.75rem; line-height: 1.5;">
            <i class="fa-solid fa-info-circle"></i>
            Ù‡Ø°Ù‡ Ø§Ù„Ù„Ù‚Ø·Ø§Øª ØªÙØ¸Ù‡Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ…Ø§ ÙƒØ§Ù†Øª Ø£Ø«Ù†Ø§Ø¡ Ø­Ø¯ÙˆØ« Ø§Ù„Ù…Ø´ÙƒÙ„Ø© â€” Ù…Ø±ØªØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… (ÙŠØ³Ø§Ø±) Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ø¯Ø« (ÙŠÙ…ÙŠÙ†).
            Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ù†Ø³Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ù„Ø­Ø¸Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙÙ‚Ø¯Ø§Ù†. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù„Ù‚Ø·Ø© Ù„ØªÙƒØ¨ÙŠØ±Ù‡Ø§ØŒ ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ù‡Ù… â† â†’ Ù„Ù„ØªÙ†Ù‚Ù„.
        </p>
    </div>
    {% endif %}

    <div class="page-footer">
        <a href="/track-events">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª</a> â€¢ <a href="/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>
</main>

<script>
// Track data from server
const trackData = {{ data | tojson }};
console.log('Track Data:', trackData);
console.log('Track ID:', trackData.track_id);
console.log('Entry:', trackData.summary.entry);
console.log('Exit:', trackData.summary.exit);

// Canvas setup
const canvas = document.getElementById('animationCanvas');
const ctx = canvas.getContext('2d');
const bgImage = document.getElementById('bgImage');
const canvasContainer = document.getElementById('canvasContainer');

// Animation state
let isPlaying = false;
let currentFrame = 0;
let animationSpeed = 1.0;
let animationId = null;
let lastTime = 0;

// Camera frame dimensions (actual camera resolution - 1280x720)
let frameWidth = 1280;
let frameHeight = 720;

// Get position data - use actual position_history if available
let positions = trackData.position_history || [];
console.log('Position history from server:', positions.length, 'points');

// If no positions, generate from entry/exit coordinates
if (positions.length === 0) {
    const entry = trackData.summary.entry || {};
    const exit = trackData.summary.exit || {};

    console.log('Generating path from entry:', entry, 'to exit:', exit);

    if (entry.x != null && entry.y != null && exit.x != null && exit.y != null) {
        const numPoints = 60;
        for (let i = 0; i < numPoints; i++) {
            const t = i / (numPoints - 1);
            // Straight line interpolation - matching actual conveyor movement
            const x = entry.x + (exit.x - entry.x) * t;
            const y = entry.y + (exit.y - entry.y) * t;
            positions.push([Math.round(x), Math.round(y)]);
        }
        console.log('Generated', positions.length, 'positions. First:', positions[0], 'Last:', positions[positions.length-1]);
    } else {
        console.warn('Missing entry/exit coordinates!');
    }
}

const totalFrames = positions.length || 1;
const duration = (trackData.animation && trackData.animation.suggested_duration_ms) || 4000;

console.log('Positions:', positions.length, 'Duration:', duration);
console.log('Entry:', trackData.summary.entry, 'Exit:', trackData.summary.exit);

// Resize canvas to match background image
function resizeCanvas() {
    if (bgImage.naturalWidth > 0) {
        // Use actual image dimensions
        frameWidth = bgImage.naturalWidth;
        frameHeight = bgImage.naturalHeight;
        canvas.width = bgImage.clientWidth;
        canvas.height = bgImage.clientHeight;
    } else {
        // Fallback dimensions
        const rect = canvasContainer.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = window.innerWidth <= 1000 ? 350 : 500;
    }
    draw();
}

// Wait for background image to load
bgImage.onload = function() {
    frameWidth = bgImage.naturalWidth;
    frameHeight = bgImage.naturalHeight;
    console.log('Background loaded:', frameWidth, 'x', frameHeight);
    resizeCanvas();
};

window.addEventListener('resize', resizeCanvas);
setTimeout(resizeCanvas, 100);

// Convert world coordinates (camera pixels) to canvas coordinates
// Note: In camera coordinates, Y=0 is at TOP of frame
// Bags travel from BOTTOM (high Y) to TOP (low Y) on conveyor
function toCanvas(x, y) {
    // Direct mapping from camera coordinates to canvas coordinates
    const cx = (x / frameWidth) * canvas.width;
    const cy = (y / frameHeight) * canvas.height;
    return [cx, cy];
}

// Draw function
function draw() {
    // Clear with transparent background (to show camera image behind)
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // If no background image, draw dark background
    if (bgImage.style.display === 'none' || !bgImage.complete || bgImage.naturalWidth === 0) {
        ctx.fillStyle = 'rgba(15, 23, 42, 0.95)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    if (positions.length < 2) {
        ctx.fillStyle = '#94a3b8';
        ctx.font = '18px Tajawal';
        ctx.textAlign = 'center';
        ctx.fillText('Ù„Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø§Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØªØ¨Ø¹', canvas.width / 2, canvas.height / 2);
        return;
    }

    // Draw full path (faint) - with shadow for visibility on camera background
    ctx.save();
    ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
    ctx.shadowBlur = 4;
    ctx.strokeStyle = 'rgba(56, 189, 248, 0.4)';
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.beginPath();
    positions.forEach((p, i) => {
        const [cx, cy] = toCanvas(p[0], p[1]);
        i === 0 ? ctx.moveTo(cx, cy) : ctx.lineTo(cx, cy);
    });
    ctx.stroke();
    ctx.restore();

    // Draw traveled path - brighter with glow
    if (currentFrame > 0) {
        ctx.save();
        ctx.shadowColor = 'rgba(56, 189, 248, 0.8)';
        ctx.shadowBlur = 8;
        ctx.strokeStyle = '#38bdf8';
        ctx.lineWidth = 5;
        ctx.beginPath();
        for (let i = 0; i <= currentFrame && i < positions.length; i++) {
            const [cx, cy] = toCanvas(positions[i][0], positions[i][1]);
            i === 0 ? ctx.moveTo(cx, cy) : ctx.lineTo(cx, cy);
        }
        ctx.stroke();
        ctx.restore();
    }

    // Entry marker - with shadow
    ctx.save();
    ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
    ctx.shadowBlur = 6;
    const [ex, ey] = toCanvas(positions[0][0], positions[0][1]);
    ctx.fillStyle = 'rgba(251, 191, 36, 0.5)';
    ctx.beginPath();
    ctx.arc(ex, ey, 16, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#fbbf24';
    ctx.beginPath();
    ctx.arc(ex, ey, 10, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
    ctx.fillStyle = 'white';
    ctx.font = 'bold 12px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('S', ex, ey);  // S for Start
    ctx.restore();

    // Current position
    if (currentFrame < positions.length) {
        ctx.save();
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        ctx.shadowBlur = 8;
        const [cx, cy] = toCanvas(positions[currentFrame][0], positions[currentFrame][1]);

        // Glow
        const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, 30);
        grad.addColorStop(0, 'rgba(56, 189, 248, 0.7)');
        grad.addColorStop(1, 'rgba(56, 189, 248, 0)');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(cx, cy, 30, 0, Math.PI * 2);
        ctx.fill();

        // Ball - bigger
        ctx.fillStyle = '#38bdf8';
        ctx.beginPath();
        ctx.arc(cx, cy, 14, 0, Math.PI * 2);
        ctx.fill();

        // White border
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Highlight
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.beginPath();
        ctx.arc(cx - 4, cy - 4, 5, 0, Math.PI * 2);
        ctx.fill();

        // Label - with shadow background
        ctx.shadowBlur = 0;
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(cx - 20, cy - 35, 40, 18);
        ctx.fillStyle = 'white';
        ctx.font = 'bold 11px Inter';
        ctx.fillText('T' + trackData.track_id, cx, cy - 24);
        ctx.restore();
    }

    // Exit marker
    ctx.save();
    ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
    ctx.shadowBlur = 6;
    const last = positions[positions.length - 1];
    const [lx, ly] = toCanvas(last[0], last[1]);
    const isCompleted = trackData.summary.event_type === 'track_completed';
    const exitColor = isCompleted ? '#2dd4bf' : '#f87171';
    const exitGlow = isCompleted ? 'rgba(45, 212, 191, 0.5)' : 'rgba(248, 113, 113, 0.5)';
    ctx.fillStyle = exitGlow;
    ctx.beginPath();
    ctx.arc(lx, ly, 16, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = exitColor;
    ctx.beginPath();
    ctx.arc(lx, ly, 10, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2.5;
    ctx.lineCap = 'round';
    ctx.beginPath();
    if (isCompleted) {
        // Checkmark âœ“
        ctx.moveTo(lx - 4, ly);
        ctx.lineTo(lx - 1, ly + 4);
        ctx.lineTo(lx + 5, ly - 4);
    } else {
        // X mark âœ—
        ctx.moveTo(lx - 4, ly - 4);
        ctx.lineTo(lx + 4, ly + 4);
        ctx.moveTo(lx + 4, ly - 4);
        ctx.lineTo(lx - 4, ly + 4);
    }
    ctx.stroke();
    ctx.restore();
}

// Animation loop
function animate(timestamp) {
    if (!isPlaying) return;

    if (!lastTime) lastTime = timestamp;
    const delta = (timestamp - lastTime) * animationSpeed;
    lastTime = timestamp;

    const progress = delta / duration;
    currentFrame += Math.ceil(progress * totalFrames);

    if (currentFrame >= totalFrames) {
        currentFrame = totalFrames - 1;
        isPlaying = false;
        document.getElementById('playBtn').innerHTML = '<i class="fa-solid fa-play"></i> ØªØ´ØºÙŠÙ„';
    }

    updateUI();
    draw();

    if (isPlaying) {
        animationId = requestAnimationFrame(animate);
    }
}

function togglePlay() {
    isPlaying = !isPlaying;
    const btn = document.getElementById('playBtn');

    if (isPlaying) {
        if (currentFrame >= totalFrames - 1) currentFrame = 0;
        lastTime = 0;
        btn.innerHTML = '<i class="fa-solid fa-pause"></i> Ø¥ÙŠÙ‚Ø§Ù';
        animationId = requestAnimationFrame(animate);
    } else {
        btn.innerHTML = '<i class="fa-solid fa-play"></i> ØªØ´ØºÙŠÙ„';
        if (animationId) cancelAnimationFrame(animationId);
    }
}

function resetAnimation() {
    isPlaying = false;
    currentFrame = 0;
    lastTime = 0;
    document.getElementById('playBtn').innerHTML = '<i class="fa-solid fa-play"></i> ØªØ´ØºÙŠÙ„';
    if (animationId) cancelAnimationFrame(animationId);
    updateUI();
    draw();
}

function updateSpeed(val) {
    animationSpeed = parseFloat(val);
    document.getElementById('speedValue').textContent = val + 'x';
}

function seekAnimation(e) {
    const rect = document.getElementById('progressBar').getBoundingClientRect();
    const ratio = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    currentFrame = Math.floor(ratio * (totalFrames - 1));
    updateUI();
    draw();
}

function updateUI() {
    const progress = totalFrames > 1 ? (currentFrame / (totalFrames - 1)) * 100 : 0;
    document.getElementById('progressFill').style.width = progress + '%';

    const currentMs = (currentFrame / totalFrames) * duration;
    document.getElementById('currentTime').textContent = formatTime(currentMs);
    document.getElementById('totalTime').textContent = formatTime(duration);
}

function formatTime(ms) {
    const s = Math.floor(ms / 1000);
    return Math.floor(s / 60) + ':' + String(s % 60).padStart(2, '0');
}

// Initialize
updateUI();
draw();

// Auto-play after delay
setTimeout(() => {
    if (positions.length > 1) togglePlay();
}, 800);
</script>

<!-- Evidence Snapshot Lightbox -->
<div id="evidenceModal" style="
    display:none; position:fixed; inset:0; z-index:9999;
    background:rgba(0,0,0,0.9); backdrop-filter:blur(8px);
    justify-content:center; align-items:center; flex-direction:column; gap:1rem;
    cursor:pointer;
" onclick="if(event.target===this)closeEvidence()">
    <div style="position:relative;max-width:95vw;max-height:90vh;" onclick="event.stopPropagation()">
        <button onclick="closeEvidence()" title="Ø¥ØºÙ„Ø§Ù‚" style="
            position:absolute; top:-14px; left:-14px; z-index:10;
            width:36px; height:36px; border-radius:50%; border:none;
            background:rgba(248,113,113,0.9); color:#fff; font-size:1.1rem;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            box-shadow:0 2px 12px rgba(0,0,0,0.4);
        "><i class="fa-solid fa-xmark"></i></button>

        <button id="evidencePrev" onclick="navigateEvidence(-1)" style="
            position:absolute; left:-50px; top:50%; transform:translateY(-50%);
            width:40px; height:40px; border-radius:50%; border:none;
            background:rgba(255,255,255,0.15); color:#fff; font-size:1.2rem;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
        "><i class="fa-solid fa-chevron-left"></i></button>

        <button id="evidenceNext" onclick="navigateEvidence(1)" style="
            position:absolute; right:-50px; top:50%; transform:translateY(-50%);
            width:40px; height:40px; border-radius:50%; border:none;
            background:rgba(255,255,255,0.15); color:#fff; font-size:1.2rem;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
        "><i class="fa-solid fa-chevron-right"></i></button>

        <img id="evidenceImg" src="" alt="" style="
            max-width:95vw; max-height:85vh; border-radius:10px;
            box-shadow:0 8px 40px rgba(0,0,0,0.5);
        ">
    </div>
    <span id="evidenceLabel" style="color:#94a3b8;font-size:0.85rem;font-weight:600;"></span>
</div>

<script>
// Evidence snapshot lightbox with navigation
const snapshotPaths = {{ data.snapshot_paths | tojson }};
let currentEvidenceIdx = 0;

function openEvidenceSnapshot(src, idx, total) {
    currentEvidenceIdx = idx - 1;  // Convert 1-based to 0-based
    showEvidenceFrame();
    document.getElementById('evidenceModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function showEvidenceFrame() {
    const filename = snapshotPaths[currentEvidenceIdx];
    document.getElementById('evidenceImg').src = '/track-events/snapshot/' + filename;
    const timeOffset = ((currentEvidenceIdx - snapshotPaths.length + 1) * 0.5).toFixed(1);
    const posLabel = currentEvidenceIdx === 0 ? ' â€” ğŸŸ¡ Ø§Ù„Ø£Ù‚Ø¯Ù…' : (currentEvidenceIdx === snapshotPaths.length - 1 ? ' â€” ğŸ”´ Ù„Ø­Ø¸Ø© Ø§Ù„ÙÙ‚Ø¯Ø§Ù†' : '');
    document.getElementById('evidenceLabel').textContent =
        'Ø¥Ø·Ø§Ø± ' + (currentEvidenceIdx + 1) + ' / ' + snapshotPaths.length + '  (' + timeOffset + 's)' + posLabel;
    document.getElementById('evidencePrev').style.display = currentEvidenceIdx > 0 ? 'flex' : 'none';
    document.getElementById('evidenceNext').style.display = currentEvidenceIdx < snapshotPaths.length - 1 ? 'flex' : 'none';
}

function navigateEvidence(dir) {
    currentEvidenceIdx = Math.max(0, Math.min(snapshotPaths.length - 1, currentEvidenceIdx + dir));
    showEvidenceFrame();
}

function closeEvidence() {
    document.getElementById('evidenceModal').style.display = 'none';
    document.body.style.overflow = '';
}

document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('evidenceModal');
    if (modal.style.display !== 'flex') return;
    if (e.key === 'Escape') closeEvidence();
    else if (e.key === 'ArrowLeft') navigateEvidence(-1);
    else if (e.key === 'ArrowRight') navigateEvidence(1);
});
</script>
</body>
</html>
