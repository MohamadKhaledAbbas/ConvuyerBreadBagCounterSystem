<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Counts ‚Äî Conveyor Counter</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/analytics.css?v=7">
    <style>
        /* ‚îÄ‚îÄ Overrides on analytics.css ‚îÄ‚îÄ */
        main { padding-top: 1.5rem; }

        /* Header */
        .page-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; flex-wrap:wrap; gap:12px }
        .page-header h1 { font-size:1.5rem; font-weight:700; color:var(--text-primary); margin:0 }
        .status-badge { display:inline-flex; align-items:center; gap:6px; padding:5px 14px; border-radius:20px; font-size:.78rem; font-weight:600; background:rgba(45,212,191,.12); color:#2dd4bf; border:1px solid rgba(45,212,191,.25) }
        .status-badge .dot { width:8px; height:8px; border-radius:50%; background:#2dd4bf; animation:pulse 2s infinite }
        .status-badge.disconnected { background:rgba(248,113,113,.12); color:#f87171; border-color:rgba(248,113,113,.25) }
        .status-badge.disconnected .dot { background:#f87171; animation:none }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

        /* Hero with 3 cols */
        .hero-card { grid-template-columns: 1fr 1fr 1fr; }
        @media(max-width:768px) { .hero-card { grid-template-columns:1fr; } }

        /* Section label */
        .section-label { font-size:.8rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--text-muted); margin-bottom:12px; display:flex; align-items:center; gap:8px }

        /* ‚îÄ‚îÄ Now-processing bar ‚îÄ‚îÄ */
        .processing-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(30,41,59,.55);
            border: 1px dashed rgba(148,163,184,.25);
            border-radius: var(--radius-lg);
            padding: 12px 20px;
            margin: 1.2rem 0 1.8rem;
            transition: all .4s ease;
            min-height: 60px;
        }
        .processing-bar.active {
            border-color: rgba(56,189,248,.35);
            background: rgba(30,41,59,.7);
        }

        .proc-thumb {
            width: 44px; height: 44px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(148,163,184,.2);
            flex-shrink: 0;
            transition: border-color .4s;
        }
        .processing-bar.active .proc-thumb { border-color: rgba(56,189,248,.35) }
        .proc-thumb img { width:100%; height:100%; object-fit:cover; }

        .proc-info { flex:1; min-width:0 }
        .proc-label { font-size:.68rem; text-transform:uppercase; letter-spacing:.08em; font-weight:700; color:var(--text-muted); line-height:1 }
        .proc-name { font-size:1rem; font-weight:700; color:var(--text-primary); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

        .proc-count-block { text-align:right; flex-shrink:0 }
        .proc-count-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            line-height: 1;
            transition: color .3s;
        }
        .processing-bar.active .proc-count-value { color: #e2e8f0 }
        .proc-count-unit { font-size:.7rem; color:var(--text-muted); font-weight:600; display:block; text-align:right }

        .proc-breakdown { font-size:.68rem; color:var(--text-muted); font-variant-numeric:tabular-nums; display:flex; gap:8px; justify-content:flex-end; margin-top:2px }
        .proc-breakdown .confirmed-part { color:rgba(45,212,191,.7) }
        .proc-breakdown .pending-part { color:rgba(56,189,248,.7) }

        .proc-status { display:flex; align-items:center; gap:6px; flex-shrink:0 }

        /* Idle state */
        .proc-idle { color:var(--text-muted); font-size:.82rem; display:flex; align-items:center; gap:8px }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 18px; height: 18px;
            border: 2.5px solid rgba(148,163,184,.2);
            border-top-color: #38bdf8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            flex-shrink: 0;
        }
        .spinner.sm { width:14px; height:14px; border-width:2px }
        .spinner.hidden { display:none }
        @keyframes spin { to { transform:rotate(360deg) } }

        /* ‚îÄ‚îÄ Connecting arrow ‚îÄ‚îÄ */
        .connect-arrow {
            display: flex;
            justify-content: center;
            margin: -6px 0 8px;
            color: rgba(148,163,184,.25);
            font-size: 1rem;
            transition: color .4s;
        }
        .connect-arrow.active { color: rgba(56,189,248,.4) }

        @keyframes confirmArrowPulse {
            0% { color: rgba(45,212,191,.7) }
            100% { color: rgba(148,163,184,.25) }
        }
        .connect-arrow.confirm-pulse { animation: confirmArrowPulse .8s ease }

        /* Card metric */
        .card-metric-large { font-variant-numeric: tabular-nums; }

        /* Card batch sub-info */
        .card-batch-info { font-size:.72rem; color:var(--text-muted); margin-top:4px; font-variant-numeric:tabular-nums; display:flex; gap:8px; justify-content:center }
        .card-batch-info .confirmed-part { color:rgba(45,212,191,.7) }
        .card-batch-info .pending-part { color:rgba(148,163,184,.7) }

        /* Animations */
        @keyframes countBump { 0%{transform:scale(1)} 50%{transform:scale(1.12)} 100%{transform:scale(1)} }
        .bump { animation:countBump .3s ease }
        @keyframes confirmFlash { 0%{box-shadow:0 0 0 0 rgba(45,212,191,.5)} 100%{box-shadow:0 0 0 14px rgba(45,212,191,0)} }
        .confirm-flash { animation:confirmFlash .7s ease }

        /* Footer */
        .footer-row { display:flex; justify-content:flex-end; padding:12px 0; font-size:.78rem; color:var(--text-muted) }
    </style>
</head>
<body>

<main>
    <!-- Header -->
    <div class="page-header">
        <h1>üìä Live Counts</h1>
        <div class="status-badge" id="statusBadge">
            <span class="dot"></span>
            <span id="statusText">Connecting‚Ä¶</span>
        </div>
    </div>

    <!-- Hero ‚Äî Batch totals -->
    <section class="hero-section">
        <div class="hero-card">
            <div class="hero-metric primary">
                <div class="hero-label">Current Batch</div>
                <div class="hero-value" id="heroBatch" style="color:var(--text-primary)">0</div>
                <div class="hero-sub">Total counted (confirmed + pending)</div>
            </div>
            <div class="hero-metric">
                <div class="hero-label">Confirmed</div>
                <div class="hero-value" id="heroConfirmed" style="color:#2dd4bf">0</div>
                <div class="hero-sub" style="color:var(--text-muted)">Persisted</div>
            </div>
            <div class="hero-metric">
                <div class="hero-label">Processing</div>
                <div class="hero-value" id="heroPending" style="color:#94a3b8">0</div>
                <div class="hero-sub" style="color:var(--text-muted)">Not yet confirmed</div>
            </div>
        </div>
    </section>

    <!-- Now Processing bar ‚Äî compact horizontal rectangle -->
    <div class="processing-bar" id="processingBar">
        <!-- Idle state -->
        <div id="procIdle" class="proc-idle">
            <span>üì¶</span>
            <span>Waiting for classifications‚Ä¶</span>
        </div>
        <!-- Active state (hidden by default) -->
        <div id="procActive" style="display:none;width:100%">
            <div style="display:flex;align-items:center;gap:16px;width:100%">
                <div class="proc-thumb" id="procThumb">
                    <img id="procImg" src="" alt="Current batch type">
                </div>
                <div class="proc-info">
                    <div class="proc-label">Now Processing</div>
                    <div class="proc-name" id="procName">‚Äî</div>
                </div>
                <div class="proc-count-block">
                    <span class="proc-count-value" id="procCountValue">0</span>
                    <span class="proc-count-unit">bags</span>
                    <div class="proc-breakdown" id="procBreakdown"></div>
                </div>
                <div class="proc-status">
                    <span class="spinner hidden" id="procSpinner"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Connecting arrow -->
    <div class="connect-arrow" id="connectArrow">‚ñº</div>

    <!-- Confirmed class cards ‚Äî all types, analytics-style -->
    <div class="section-label">Counts by Type</div>
    <section class="grid-container" id="classGrid">
        <!-- Populated by JS on init -->
    </section>

    <!-- Footer -->
    <div class="footer-row"><span id="lastUpdate">‚Äî</span></div>
</main>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let bagTypes = {};
let allTypeNames = [];
let prevConfirmed = {};
let isFirstRender = true;

const $id = id => document.getElementById(id);

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function bump(el) {
    el.classList.remove('bump');
    void el.offsetWidth;
    el.classList.add('bump');
}

function confirmFlash(el) {
    el.classList.remove('confirm-flash');
    void el.offsetWidth;
    el.classList.add('confirm-flash');
}

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function thumbUrl(className) {
    const bt = bagTypes[className];
    if (bt && bt.thumb) return '/' + bt.thumb;
    const letter = className ? className.charAt(0) : '?';
    return 'https://placehold.co/170x170/1e293b/64748b?text=' + encodeURIComponent(letter);
}

function imgTag(className) {
    const safe = (className || '?').charAt(0);
    return '<img src="' + thumbUrl(className) + '" alt="' + escHtml(className) + '" loading="lazy" onerror="this.src=\'https://placehold.co/170x170/1e293b/64748b?text=' + encodeURIComponent(safe) + '\'">';
}

// ‚îÄ‚îÄ Build all type cards once (including zeros) ‚îÄ‚îÄ
function buildClassCards() {
    const grid = $id('classGrid');
    grid.innerHTML = '';

    // Sort: non-Rejected first alphabetically, Rejected last
    const sorted = [...allTypeNames].sort((a, b) => {
        if (a === 'Rejected') return 1;
        if (b === 'Rejected') return -1;
        return a.localeCompare(b);
    });

    sorted.forEach(name => {
        const card = document.createElement('div');
        card.className = 'stat-card';
        card.dataset.cls = name;
        card.innerHTML =
            '<div class="card-header stacked">' +
                '<div class="card-title">' + escHtml(name) + '</div>' +
                '<div class="thumb-container">' + imgTag(name) + '</div>' +
            '</div>' +
            '<div class="card-metric-large" data-role="count" style="color:#2dd4bf">0</div>' +
            '<div class="card-batch-info" data-role="batch-info"></div>';
        grid.appendChild(card);
    });
}

// ‚îÄ‚îÄ Update confirmed cards with batch counts ‚îÄ‚îÄ
function updateClassCards(confirmed, pending) {
    const grid = $id('classGrid');
    const cards = grid.querySelectorAll('.stat-card');

    cards.forEach(card => {
        const name = card.dataset.cls;
        const conf = (confirmed || {})[name] || 0;
        const pend = (pending || {})[name] || 0;
        const batch = conf + pend;
        const el = card.querySelector('[data-role="count"]');
        const infoEl = card.querySelector('[data-role="batch-info"]');
        const prev = parseInt(el.textContent) || 0;

        if (prev !== batch) {
            el.textContent = batch;
            if (!isFirstRender && batch > prev) {
                bump(el);
                confirmFlash(card);
            }
        }

        // Show breakdown only when there are items
        if (batch > 0 && pend > 0) {
            infoEl.innerHTML = '<span class="confirmed-part">‚úì ' + conf + ' confirmed</span>' +
                               '<span class="pending-part">‚è≥ +' + pend + ' pending</span>';
        } else if (batch > 0) {
            infoEl.innerHTML = '<span class="confirmed-part">‚úì ' + conf + ' confirmed</span>';
        } else {
            infoEl.innerHTML = '';
        }
    });
}

// ‚îÄ‚îÄ Update processing bar ‚îÄ‚îÄ
let prevBatchType = null;

function updateProcessingBar(data, allPending) {
    const bar = $id('processingBar');
    const idleEl = $id('procIdle');
    const activeEl = $id('procActive');
    const arrow = $id('connectArrow');
    const pendingTotal = (data.pending_total || 0) + (data.just_classified_total || 0);
    const batchType = data.current_batch_type;

    if (!batchType) {
        idleEl.style.display = '';
        activeEl.style.display = 'none';
        bar.classList.remove('active');
        arrow.classList.remove('active');
        return;
    }

    // Show active state
    idleEl.style.display = 'none';
    activeEl.style.display = '';

    // Batch type changed?
    if (prevBatchType !== batchType) {
        $id('procName').textContent = batchType;
        $id('procImg').src = thumbUrl(batchType);
        $id('procImg').alt = batchType;
        if (prevBatchType && !isFirstRender) confirmFlash(bar);
        prevBatchType = batchType;
    }

    // Count for this type: confirmed + pending
    const conf = (data.confirmed || {})[batchType] || 0;
    const pend = (allPending || {})[batchType] || 0;
    const typeCount = conf + pend;

    const countEl = $id('procCountValue');
    const prev = parseInt(countEl.textContent) || 0;
    if (prev !== typeCount) {
        countEl.textContent = typeCount;
        if (!isFirstRender) bump(countEl);
    }

    // Breakdown
    const breakdownEl = $id('procBreakdown');
    if (pend > 0) {
        breakdownEl.innerHTML = '<span class="confirmed-part">‚úì ' + conf + '</span>' +
                                '<span class="pending-part">‚è≥ +' + pend + '</span>';
    } else {
        breakdownEl.innerHTML = '<span class="confirmed-part">‚úì ' + conf + '</span>';
    }

    // Spinner + arrow active state
    const spinner = $id('procSpinner');
    if (pendingTotal > 0) {
        bar.classList.add('active');
        spinner.classList.remove('hidden');
        arrow.classList.add('active');
    } else {
        bar.classList.remove('active');
        spinner.classList.add('hidden');
        arrow.classList.remove('active');
    }

    // Pulse arrow on confirmations
    if (!isFirstRender && prev > 0 && typeCount > prev) {
        arrow.classList.remove('confirm-pulse');
        void arrow.offsetWidth;
        arrow.classList.add('confirm-pulse');
    }
}

// ‚îÄ‚îÄ Main UI update ‚îÄ‚îÄ
function updateUI(data) {
    const ct = data.confirmed_total || 0;
    const pt = (data.pending_total || 0) + (data.just_classified_total || 0);
    const batchTotal = ct + pt;

    // Hero
    const heroBatch = $id('heroBatch');
    const heroConfirmed = $id('heroConfirmed');
    const heroPending = $id('heroPending');
    if (heroBatch.textContent !== String(batchTotal)) { heroBatch.textContent = batchTotal; if (!isFirstRender) bump(heroBatch); }
    if (heroConfirmed.textContent !== String(ct)) { heroConfirmed.textContent = ct; if (!isFirstRender) bump(heroConfirmed); }
    if (heroPending.textContent !== String(pt)) { heroPending.textContent = pt; if (!isFirstRender) bump(heroPending); }

    // Merge pending + just_classified for per-class pending counts
    const allPending = {};
    for (const [cls, n] of Object.entries(data.pending || {})) { allPending[cls] = (allPending[cls] || 0) + n; }
    for (const [cls, n] of Object.entries(data.just_classified || {})) { allPending[cls] = (allPending[cls] || 0) + n; }

    // Processing bar
    updateProcessingBar(data, allPending);

    // Confirmed type cards
    updateClassCards(data.confirmed, allPending);

    // Footer
    $id('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();

    // Track state
    prevConfirmed = Object.assign({}, data.confirmed || {});
    isFirstRender = false;
}

// ‚îÄ‚îÄ SSE ‚îÄ‚îÄ
function connectSSE() {
    const es = new EventSource('/api/counts/stream');
    es.onopen = () => {
        $id('statusBadge').className = 'status-badge';
        $id('statusText').textContent = 'Connected';
    };
    es.onmessage = (e) => {
        try { updateUI(JSON.parse(e.data)); } catch(err) { console.warn('SSE parse error', err); }
    };
    es.onerror = () => {
        $id('statusBadge').className = 'status-badge disconnected';
        $id('statusText').textContent = 'Reconnecting‚Ä¶';
        es.close();
        setTimeout(connectSSE, 3000);
    };
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
    // Load bag types
    try {
        const resp = await fetch('/api/bag-types');
        if (resp.ok) {
            const types = await resp.json();
            types.forEach(bt => {
                bagTypes[bt.name] = bt;
                if (bt.name !== 'Rejected') allTypeNames.push(bt.name);
            });
            if (bagTypes['Rejected']) allTypeNames.push('Rejected');
        }
    } catch(e) { console.warn('Failed to load bag types', e); }

    buildClassCards();

    // Fetch initial state
    try {
        const resp = await fetch('/api/counts');
        if (resp.ok) updateUI(await resp.json());
    } catch(e) {}

    connectSSE();
}
init();
</script>

</body>
</html>
