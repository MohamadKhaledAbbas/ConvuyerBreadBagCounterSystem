<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ù„Ø­Ø¸ÙŠ â€” Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¥Ø­ØµØ§Ø¡ Ø£ÙƒÙŠØ§Ø³ Ø§Ù„Ø®Ø¨Ø²</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-deep: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-primary: #38bdf8;
            --accent-success: #2dd4bf;
            --accent-warning: #fbbf24;
            --accent-danger: #f87171;
            --accent-purple: #a78bfa;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Tajawal', 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        /* Force English numbers */
        .hero-value, .batch-count-value, .card-metric-large, #heroBatch, #heroConfirmed, #heroPending, #curCount, #prevCount {
            font-family: 'Inter', sans-serif !important;
            font-feature-settings: "tnum" 1;
        }
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }
        .back-home {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            transition: color 0.2s;
        }
        .back-home:hover { color: var(--accent-success); }

        /* Status badge */
        .status-badge { display:inline-flex; align-items:center; gap:8px; padding:8px 16px; border-radius:20px; font-size:0.85rem; font-weight:600; background:rgba(45,212,191,.12); color:var(--accent-success); border:1px solid rgba(45,212,191,.25) }
        .status-badge .dot { width:10px; height:10px; border-radius:50%; background:var(--accent-success); animation:pulse 2s infinite }
        .status-badge.disconnected { background:rgba(248,113,113,.12); color:var(--accent-danger); border-color:rgba(248,113,113,.25) }
        .status-badge.disconnected .dot { background:var(--accent-danger); animation:none }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

        /* Hero Section */
        .hero-section { margin-bottom: 2rem; }
        .hero-card {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }
        @media(max-width:768px) { .hero-card { grid-template-columns:1fr; } }
        .hero-metric { text-align: center; }
        .hero-metric.primary { border-left: 1px solid var(--glass-border); border-right: 1px solid var(--glass-border); }
        @media(max-width:768px) { .hero-metric.primary { border: none; border-top: 1px solid var(--glass-border); border-bottom: 1px solid var(--glass-border); padding: 1rem 0; } }
        .hero-label { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .hero-value { font-size: 3rem; font-weight: 800; line-height: 1; }
        .hero-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; }

        /* Section label */
        .section-label { font-size:.85rem; font-weight:700; color:var(--text-muted); margin-bottom:1rem; display:flex; align-items:center; gap:8px }

        /* â”€â”€ Batch timeline â€” current + previous â”€â”€ */
        .batch-timeline {
            margin: 1.2rem 0 1.8rem;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0;
        }

        .batch-card {
            position: relative;
            display: flex;
            flex-direction: column;
            background: rgba(30,41,59,.55);
            border: 1px solid rgba(148,163,184,.15);
            border-radius: var(--radius-lg);
            padding: 16px 28px;
            transition: all .4s ease;
            width: 100%;
            box-sizing: border-box;
        }
        .batch-card.current {
            border-color: rgba(56,189,248,.4);
            background: linear-gradient(135deg, rgba(30,41,59,.8), rgba(15,23,42,.85));
            box-shadow: 0 4px 24px rgba(56,189,248,.08);
        }
        .batch-card.previous {
            background: rgba(30,41,59,.35);
            border-color: rgba(148,163,184,.12);
            opacity: .75;
        }

        .batch-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: #0ea5e9;
            color: #fff;
            font-size: .68rem;
            font-weight: 700;
            padding: 2px 12px;
            border-radius: 10px;
            letter-spacing: .04em;
        }
        .prev-badge { background: rgba(100,116,139,.7) }

        .batch-inner {
            display: flex;
            direction: ltr;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .batch-thumb {
            width: 60px; height: 60px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(148,163,184,.2);
            flex-shrink: 0;
        }
        .batch-card.current .batch-thumb { border-color: rgba(56,189,248,.4); width: 68px; height: 68px }
        .batch-thumb img { width:100%; height:100%; object-fit:cover; }

        .batch-info { flex:1; min-width:0; text-align:left }
        .batch-type { font-size:1.1rem; font-weight:700; color:var(--text-primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
        .batch-card.current .batch-type { font-size:1.2rem }
        .batch-sub { font-size:.73rem; color:var(--text-muted); margin-top:2px; font-variant-numeric:tabular-nums; display:flex; gap:8px }
        .batch-sub .confirmed-part { color:rgba(45,212,191,.7) }
        .batch-sub .pending-part { color:rgba(56,189,248,.7) }

        .batch-count-block { text-align:right; flex-shrink:0 }
        .batch-count-value {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            line-height: 1;
            transition: color .3s;
            letter-spacing: -1px;
        }
        .batch-card.current .batch-count-value { font-size: 3.2rem; color: #f1f5f9 }
        .batch-count-unit { font-size:.75rem; color:var(--text-muted); font-weight:600; display:block; text-align:right }

        .batch-status { display:flex; align-items:center; gap:6px; flex-shrink:0 }

        .batch-connector {
            display: flex;
            justify-content: center;
            color: rgba(148,163,184,.25);
            margin: -2px 0;
            transition: color .4s;
        }
        .batch-connector.active { color: rgba(56,189,248,.35) }

        @keyframes connectorPulse {
            0% { color: rgba(45,212,191,.7) }
            100% { color: rgba(148,163,184,.25) }
        }
        .batch-connector.confirm-pulse { animation: connectorPulse .8s ease }

        .batch-idle { color:var(--text-muted); font-size:.82rem; display:flex; align-items:center; gap:8px; padding: 20px 0 }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 18px; height: 18px;
            border: 2.5px solid rgba(148,163,184,.2);
            border-top-color: #38bdf8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            flex-shrink: 0;
        }
        .spinner.sm { width:14px; height:14px; border-width:2px }
        .spinner.hidden { display:none }
        @keyframes spin { to { transform:rotate(360deg) } }

        /* â”€â”€ Connecting arrow â”€â”€ */
        .connect-arrow {
            display: flex;
            justify-content: center;
            margin: -6px 0 8px;
            color: rgba(148,163,184,.25);
            font-size: 1rem;
            transition: color .4s;
        }
        .connect-arrow.active { color: rgba(56,189,248,.4) }

        @keyframes confirmArrowPulse {
            0% { color: rgba(45,212,191,.7) }
            100% { color: rgba(148,163,184,.25) }
        }
        .connect-arrow.confirm-pulse { animation: confirmArrowPulse .8s ease }

        /* Card metric */
        .card-metric-large { font-variant-numeric: tabular-nums; font-size: 2.5rem; font-weight: 800; text-align: center; margin: 0.5rem 0; }

        /* Grid Container for Class Cards */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        /* Stat Card */
        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            text-align: center;
        }
        .stat-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(56, 189, 248, 0.15);
        }

        /* Card Header */
        .card-header.stacked {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        .card-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Thumbnail Container */
        .thumb-container {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid rgba(56, 189, 248, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .thumb-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Card batch sub-info */
        .card-batch-info { font-size:.72rem; color:var(--text-muted); margin-top:4px; font-variant-numeric:tabular-nums; display:flex; gap:8px; justify-content:center }
        .card-batch-info .confirmed-part { color:rgba(45,212,191,.7) }
        .card-batch-info .pending-part { color:rgba(148,163,184,.7) }

        /* Animations */
        @keyframes countBump { 0%{transform:scale(1)} 50%{transform:scale(1.12)} 100%{transform:scale(1)} }
        .bump { animation:countBump .3s ease }
        @keyframes confirmFlash { 0%{box-shadow:0 0 0 0 rgba(45,212,191,.5)} 100%{box-shadow:0 0 0 14px rgba(45,212,191,0)} }
        .confirm-flash { animation:confirmFlash .7s ease }

        /* Footer */
        .footer-row {
            display:flex;
            justify-content:center;
            padding:2rem 0;
            font-size:0.85rem;
            color:var(--text-muted);
            gap: 1rem;
        }
        .footer-row a {
            color: var(--accent-primary);
            text-decoration: none;
        }
        .footer-row a:hover { color: var(--accent-success); }
    </style>
</head>
<body>

<main>
    <a href="/" class="back-home"><i class="fa-solid fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

    <!-- Header -->
    <div class="page-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:2rem; flex-wrap:wrap; gap:1rem;">
        <h1 style="font-size:2rem; font-weight:800; background:linear-gradient(135deg, var(--accent-primary), var(--accent-purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin:0;">
            <i class="fa-solid fa-gauge-high"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ù„Ø­Ø¸ÙŠ
        </h1>
        <div class="status-badge" id="statusBadge">
            <span class="dot"></span>
            <span id="statusText">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„...</span>
        </div>
    </div>

    <!-- Hero â€” Batch totals -->
    <section class="hero-section">
        <div class="hero-card">
            <div class="hero-metric primary">
                <div class="hero-label">Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                <div class="hero-value" id="heroBatch" style="color:var(--text-primary)">0</div>
                <div class="hero-sub">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯ (Ù…Ø¤ÙƒØ¯ + Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©)</div>
            </div>
            <div class="hero-metric">
                <div class="hero-label">Ù…Ø¤ÙƒØ¯</div>
                <div class="hero-value" id="heroConfirmed" style="color:#2dd4bf">0</div>
                <div class="hero-sub" style="color:var(--text-muted)">ØªÙ… Ø§Ù„Ø­ÙØ¸</div>
            </div>
            <div class="hero-metric">
                <div class="hero-label">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
                <div class="hero-value" id="heroPending" style="color:#94a3b8">0</div>
                <div class="hero-sub" style="color:var(--text-muted)">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¨Ø¹Ø¯</div>
            </div>
        </div>
    </section>

    <!-- Recent batches â€” current + previous -->
    <section class="batch-timeline" id="batchTimeline">
        <!-- Current batch -->
        <div class="batch-card current" id="batchCurrent">
            <div class="batch-badge">Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
            <div class="batch-inner">
                <div class="batch-thumb" id="curThumb">
                    <img id="curImg" src="" alt="">
                </div>
                <div class="batch-info">
                    <div class="batch-type" id="curName">â€”</div>
                    <div class="batch-sub" id="curSub"></div>
                </div>
                <div class="batch-count-block">
                    <span class="batch-count-value" id="curCount">0</span>
                    <span class="batch-count-unit">ÙƒÙŠØ³</span>
                </div>
                <div class="batch-status" id="curStatus">
                    <span class="spinner hidden" id="curSpinner"></span>
                </div>
            </div>
        </div>

        <!-- Connecting line -->
        <div class="batch-connector" id="batchConnector">
            <svg width="32" height="24" viewBox="0 0 32 24"><path d="M16 0 v24" stroke="currentColor" stroke-width="2" stroke-dasharray="4 3" fill="none"/></svg>
        </div>

        <!-- Previous batch -->
        <div class="batch-card previous" id="batchPrevious" style="display:none">
            <div class="batch-badge prev-badge">Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
            <div class="batch-inner">
                <div class="batch-thumb" id="prevThumb">
                    <img id="prevImg" src="" alt="">
                </div>
                <div class="batch-info">
                    <div class="batch-type" id="prevName">â€”</div>
                    <div class="batch-sub" id="prevSub"></div>
                </div>
                <div class="batch-count-block">
                    <span class="batch-count-value" id="prevCount">0</span>
                    <span class="batch-count-unit">ÙƒÙŠØ³</span>
                </div>
            </div>
        </div>

        <!-- Idle state (no batches yet) -->
        <div class="batch-idle" id="batchIdle">
            <span>ğŸ“¦</span>
            <span>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØµÙ†ÙŠÙØ§Øªâ€¦</span>
        </div>
    </section>

    <!-- Connecting arrow to class cards -->
    <div class="connect-arrow" id="connectArrow">â–¼</div>

    <!-- â”€â”€ State Machine Insight â”€â”€ -->
    <section id="smInsight" style="margin: 0 0 1.8rem; display:none;">
        <div class="section-label"><i class="fa-solid fa-diagram-project"></i> Ø­Ø§Ù„Ø© Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‚Ø±Ø§Ø±</div>
        <div style="background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius-lg); padding:1.25rem 1.5rem; backdrop-filter:blur(10px);">
            <!-- Top row: state badge, run class, run progress, last decision -->
            <div style="display:flex; align-items:center; gap:1.25rem; flex-wrap:wrap;">
                <span id="smStateBadge" style="display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;font-size:.8rem;font-weight:700;border:1px solid;letter-spacing:.03em;">â€”</span>
                <div style="min-width:110px;">
                    <div style="font-size:.72rem;color:var(--text-muted);margin-bottom:2px;">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                    <div id="smRunClass" style="font-weight:700;color:var(--text-primary);font-size:.95rem;">â€”</div>
                </div>
                <div style="flex:2;min-width:180px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px;font-size:.72rem;color:var(--text-muted);">
                        <span>ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ´ØºÙŠÙ„</span>
                        <span id="smRunProgress" style="font-family:'Inter',monospace;">0/5</span>
                    </div>
                    <div style="background:rgba(255,255,255,.08);border-radius:4px;height:8px;overflow:hidden;"
                         role="progressbar" aria-valuemin="0" aria-valuemax="100" id="smRunBarTrack">
                        <div id="smRunBar" style="background:var(--accent-success);height:100%;border-radius:4px;width:0%;transition:width .35s ease;"></div>
                    </div>
                    <div id="smRunHint" style="font-size:.68rem;color:var(--text-muted);margin-top:3px;">â€”</div>
                </div>
                <div style="min-width:130px;text-align:right;">
                    <div style="font-size:.72rem;color:var(--text-muted);margin-bottom:2px;">Ø¢Ø®Ø± Ù‚Ø±Ø§Ø±</div>
                    <div id="smLastDecision" style="font-size:.78rem;color:var(--text-secondary);word-break:break-all;">â€”</div>
                </div>
            </div>
            <!-- Transition history -->
            <div id="smTransitionHistory"></div>
        </div>
    </section>

    <!-- Confirmed class cards â€” all types, analytics-style -->
    <div class="section-label">Ø§Ù„Ø¹Ø¯Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</div>
    <section class="grid-container" id="classGrid">
        <!-- Populated by JS on init -->
    </section>

    <!-- Footer -->
    <div class="footer-row">
        <span id="lastUpdate">â€”</span>
        <span>â€¢</span>
        <a href="/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <span>â€¢</span>
        <a href="/analytics">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</a>
        <span>â€¢</span>
        <a href="/snapshot/view">Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</a>
    </div>
</main>

<script>
// â”€â”€ State â”€â”€
let bagTypes = {};
let allTypeNames = [];
let prevConfirmed = {};
let isFirstRender = true;

const $id = id => document.getElementById(id);

// â”€â”€ Helpers â”€â”€
function bump(el) {
    el.classList.remove('bump');
    void el.offsetWidth;
    el.classList.add('bump');
}

function confirmFlash(el) {
    el.classList.remove('confirm-flash');
    void el.offsetWidth;
    el.classList.add('confirm-flash');
}

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function thumbUrl(className) {
    const bt = bagTypes[className];
    if (bt && bt.thumb) return '/' + bt.thumb;
    const letter = className ? className.charAt(0) : '?';
    return 'https://placehold.co/170x170/1e293b/64748b?text=' + encodeURIComponent(letter);
}

function imgTag(className) {
    const safe = (className || '?').charAt(0);
    return '<img src="' + thumbUrl(className) + '" alt="' + escHtml(className) + '" loading="lazy" onerror="this.src=\'https://placehold.co/170x170/1e293b/64748b?text=' + encodeURIComponent(safe) + '\'">';
}

// â”€â”€ Build all type cards once (including zeros) â”€â”€
function buildClassCards() {
    const grid = $id('classGrid');
    grid.innerHTML = '';

    // Sort: non-Rejected first alphabetically, Rejected last
    const sorted = [...allTypeNames].sort((a, b) => {
        if (a === 'Rejected') return 1;
        if (b === 'Rejected') return -1;
        return a.localeCompare(b);
    });

    sorted.forEach(name => {
        const card = document.createElement('div');
        card.className = 'stat-card';
        card.dataset.cls = name;
        card.innerHTML =
            '<div class="card-header stacked">' +
                '<div class="card-title">' + escHtml(name) + '</div>' +
                '<div class="thumb-container">' + imgTag(name) + '</div>' +
            '</div>' +
            '<div class="card-metric-large" data-role="count" style="color:#2dd4bf">0</div>' +
            '<div class="card-batch-info" data-role="batch-info"></div>';
        grid.appendChild(card);
    });
}

// â”€â”€ Update confirmed cards with batch counts â”€â”€
function updateClassCards(confirmed, pending) {
    const grid = $id('classGrid');
    const cards = grid.querySelectorAll('.stat-card');

    cards.forEach(card => {
        const name = card.dataset.cls;
        const conf = (confirmed || {})[name] || 0;
        const pend = (pending || {})[name] || 0;
        const batch = conf + pend;
        const el = card.querySelector('[data-role="count"]');
        const infoEl = card.querySelector('[data-role="batch-info"]');
        const prev = parseInt(el.textContent) || 0;

        if (prev !== batch) {
            el.textContent = batch;
            if (!isFirstRender && batch > prev) {
                bump(el);
                confirmFlash(card);
            }
        }

        // Show breakdown only when there are items
        if (batch > 0 && pend > 0) {
            infoEl.innerHTML = '<span class="confirmed-part">âœ“ ' + conf + ' Ù…Ø¤ÙƒØ¯</span>' +
                               '<span class="pending-part">â³ +' + pend + ' Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>';
        } else if (batch > 0) {
            infoEl.innerHTML = '<span class="confirmed-part">âœ“ ' + conf + ' Ù…Ø¤ÙƒØ¯</span>';
        } else {
            infoEl.innerHTML = '';
        }
    });
}

// â”€â”€ Update batch timeline (current + previous) â”€â”€
let prevCurrentType = null;
let prevPreviousType = null;

function updateBatchTimeline(data, allPending) {
    const idleEl = $id('batchIdle');
    const curCard = $id('batchCurrent');
    const prevCard = $id('batchPrevious');
    const connector = $id('batchConnector');
    const arrow = $id('connectArrow');
    const pendingTotal = data.pending_total || 0;
    const curType = data.current_batch_type;
    const prType = data.previous_batch_type;

    if (!curType) {
        idleEl.style.display = '';
        curCard.style.display = 'none';
        prevCard.style.display = 'none';
        connector.style.display = 'none';
        arrow.classList.remove('active');
        return;
    }

    // Show current batch
    idleEl.style.display = 'none';
    curCard.style.display = '';

    // Current batch type changed?
    if (prevCurrentType !== curType) {
        $id('curName').textContent = curType;
        $id('curImg').src = thumbUrl(curType);
        $id('curImg').alt = curType;
        if (prevCurrentType && !isFirstRender) confirmFlash(curCard);
        prevCurrentType = curType;
    }

    // Current batch total = confirmed + pending for this type
    const curConf = (data.confirmed || {})[curType] || 0;
    const curPend = (allPending || {})[curType] || 0;
    const curTotal = curConf + curPend;
    const curCountEl = $id('curCount');
    const prevCurVal = parseInt(curCountEl.textContent) || 0;
    if (prevCurVal !== curTotal) {
        curCountEl.textContent = curTotal;
        if (!isFirstRender) bump(curCountEl);
    }

    // Current batch breakdown
    const curSubEl = $id('curSub');
    if (curPend > 0) {
        curSubEl.innerHTML = '<span class="confirmed-part">âœ“ ' + curConf + ' Ù…Ø¤ÙƒØ¯</span><span class="pending-part">â³ +' + curPend + ' Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>';
    } else {
        curSubEl.innerHTML = '<span class="confirmed-part">âœ“ ' + curConf + ' Ù…Ø¤ÙƒØ¯</span>';
    }

    // Spinner on current batch
    const spinner = $id('curSpinner');
    if (pendingTotal > 0) {
        spinner.classList.remove('hidden');
        arrow.classList.add('active');
    } else {
        spinner.classList.add('hidden');
        arrow.classList.remove('active');
    }

    // Previous batch
    if (prType && prType !== curType) {
        prevCard.style.display = '';
        connector.style.display = '';
        connector.classList.toggle('active', pendingTotal > 0);

        if (prevPreviousType !== prType) {
            $id('prevName').textContent = prType;
            $id('prevImg').src = thumbUrl(prType);
            $id('prevImg').alt = prType;
            prevPreviousType = prType;
        }

        const prConf = (data.confirmed || {})[prType] || 0;
        const prPend = (allPending || {})[prType] || 0;
        const prTotal = prConf + prPend;
        const prevCountEl = $id('prevCount');
        const prevPrVal = parseInt(prevCountEl.textContent) || 0;
        if (prevPrVal !== prTotal) {
            prevCountEl.textContent = prTotal;
            if (!isFirstRender) bump(prevCountEl);
        }

        const prevSubEl = $id('prevSub');
        if (prPend > 0) {
            prevSubEl.innerHTML = '<span class="confirmed-part">âœ“ ' + prConf + ' Ù…Ø¤ÙƒØ¯</span><span class="pending-part">â³ +' + prPend + ' Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>';
        } else {
            prevSubEl.innerHTML = '<span class="confirmed-part">âœ“ ' + prConf + ' Ù…Ø¤ÙƒØ¯</span>';
        }
    } else {
        prevCard.style.display = 'none';
        connector.style.display = 'none';
    }

    // Pulse connector on confirmations
    if (!isFirstRender && prevCurVal > 0 && curTotal > prevCurVal) {
        connector.classList.remove('confirm-pulse');
        void connector.offsetWidth;
        connector.classList.add('confirm-pulse');
        arrow.classList.remove('confirm-pulse');
        void arrow.offsetWidth;
        arrow.classList.add('confirm-pulse');
    }
}

// â”€â”€ State Machine Insight panel â”€â”€
const SM_STATE_COLORS = {
    'ACCUMULATING':    '#fbbf24',
    'CONFIRMED_BATCH': '#2dd4bf',
    'TRANSITION':      '#f87171',
    'WINDOW':          '#94a3b8'
};
const SM_STATE_LABELS = {
    'ACCUMULATING':    'ØªØ¬Ù…ÙŠØ¹',
    'CONFIRMED_BATCH': 'Ø¯ÙØ¹Ø© Ù…Ø¤ÙƒØ¯Ø©',
    'TRANSITION':      'Ø§Ù†ØªÙ‚Ø§Ù„',
    'WINDOW':          'Ù†Ø§ÙØ°Ø©'
};

function updateStateMachinePanel(data) {
    const sm   = data.state_machine;
    const hist = data.transition_history || [];
    const panel = $id('smInsight');

    if (!sm || sm.algorithm !== 'run_length') {
        panel.style.display = 'none';
        return;
    }
    panel.style.display = '';

    // State badge
    const badge = $id('smStateBadge');
    const color = SM_STATE_COLORS[sm.state] || '#94a3b8';
    badge.textContent = SM_STATE_LABELS[sm.state] || sm.state;
    badge.style.background   = color + '22';
    badge.style.color        = color;
    badge.style.borderColor  = color + '55';

    // Current run class
    $id('smRunClass').textContent = sm.current_run_class || 'â€”';

    // Run progress bar
    const target  = sm.state === 'TRANSITION' ? sm.transition_confirm_count : sm.run_target;
    const current = sm.current_run_length || 0;
    const pct     = target > 0 ? Math.min(100, (current / target) * 100) : 0;
    $id('smRunProgress').textContent = current + '/' + target;
    $id('smRunBar').style.width      = pct + '%';
    $id('smRunBar').style.background = sm.state === 'TRANSITION' ? '#f87171' : '#2dd4bf';
    $id('smRunBarTrack').setAttribute('aria-valuenow', Math.round(pct));

    // Hint under progress bar
    const hint = sm.state === 'TRANSITION'
        ? 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ â€“ ÙŠÙ„Ø²Ù… ' + sm.transition_confirm_count + ' Ø¹Ù†ØµØ±'
        : sm.state === 'ACCUMULATING'
        ? 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙØ¹Ø© â€“ ÙŠÙ„Ø²Ù… ' + sm.run_target + ' Ø¹Ù†ØµØ± Ù…ØªØªØ§Ù„ÙŠ'
        : 'Ø¯ÙØ¹Ø© Ù…Ø¤ÙƒØ¯Ø© â€“ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ù†Ø­Ø±Ø§Ù: ' + sm.max_blip;
    $id('smRunHint').textContent = hint;

    // Last decision
    $id('smLastDecision').textContent = sm.last_decision || 'â€”';

    // Transition history
    _renderTransitionHistory(hist);
}

function _renderTransitionHistory(history) {
    const el = $id('smTransitionHistory');
    if (!history || !history.length) { el.innerHTML = ''; return; }

    const rows = history.slice(-5).reverse().map(t => {
        const from    = escHtml(t.from_class || 'â€”');
        const to      = escHtml(t.to_class || 'â€”');
        const ts      = t.timestamp ? new Date(t.timestamp * 1000).toLocaleTimeString('ar') : '';
        const lbl     = t.type === 'initial_batch' ? 'Ø¨Ø¯Ø¡ Ø¯ÙØ¹Ø©' : 'ØªØºÙŠÙŠØ± Ø¯ÙØ¹Ø©';
        const toColor = t.type === 'initial_batch' ? 'var(--accent-success)' : 'var(--accent-warning)';
        return `<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-top:1px solid rgba(255,255,255,.05);font-size:.78rem;">
            <span style="color:var(--text-muted);min-width:65px;font-size:.7rem;">${ts}</span>
            <span style="color:var(--text-secondary);">${from}</span>
            <span style="color:var(--text-muted);">â†’</span>
            <span style="font-weight:700;color:${toColor};">${to}</span>
            <span style="color:var(--text-muted);margin-inline-start:auto;font-size:.7rem;">${lbl}</span>
            <span style="color:var(--text-muted);font-size:.7rem;font-family:'Inter',monospace;">Ã—${t.run_length || 0}</span>
        </div>`;
    }).join('');

    el.innerHTML =
        '<div style="font-size:.73rem;color:var(--text-muted);margin:10px 0 4px;">Ø³Ø¬Ù„ Ø§Ù„ØªØ­ÙˆÙ„Ø§Øª</div>' +
        rows;
}

// â”€â”€ Main UI update â”€â”€
function updateUI(data) {
    const ct = data.confirmed_total || 0;
    const pt = data.pending_total || 0;
    const batchTotal = ct + pt;

    // Hero
    const heroBatch = $id('heroBatch');
    const heroConfirmed = $id('heroConfirmed');
    const heroPending = $id('heroPending');
    if (heroBatch.textContent !== String(batchTotal)) { heroBatch.textContent = batchTotal; if (!isFirstRender) bump(heroBatch); }
    if (heroConfirmed.textContent !== String(ct)) { heroConfirmed.textContent = ct; if (!isFirstRender) bump(heroConfirmed); }
    if (heroPending.textContent !== String(pt)) { heroPending.textContent = pt; if (!isFirstRender) bump(heroPending); }

    // Per-class pending counts from smoother (authoritative source)
    const allPending = {};
    for (const [cls, n] of Object.entries(data.pending || {})) { allPending[cls] = (allPending[cls] || 0) + n; }

    // Batch timeline (current + previous)
    updateBatchTimeline(data, allPending);

    // State machine insight panel
    updateStateMachinePanel(data);

    // Confirmed type cards
    updateClassCards(data.confirmed, allPending);

    // Footer
    $id('lastUpdate').textContent = 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« ' + new Date().toLocaleTimeString('ar');

    // Track state
    prevConfirmed = Object.assign({}, data.confirmed || {});
    isFirstRender = false;
}

// â”€â”€ SSE â”€â”€
function connectSSE() {
    const es = new EventSource('/api/counts/stream');
    es.onopen = () => {
        $id('statusBadge').className = 'status-badge';
        $id('statusText').textContent = 'Ù…ØªØµÙ„';
    };
    es.onmessage = (e) => {
        try { updateUI(JSON.parse(e.data)); } catch(err) { console.warn('SSE parse error', err); }
    };
    es.onerror = () => {
        $id('statusBadge').className = 'status-badge disconnected';
        $id('statusText').textContent = 'Ø¬Ø§Ø±Ù Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„â€¦';
        es.close();
        setTimeout(connectSSE, 3000);
    };
}

// â”€â”€ Init â”€â”€
async function init() {
    // Load bag types
    try {
        const resp = await fetch('/api/bag-types');
        if (resp.ok) {
            const types = await resp.json();
            types.forEach(bt => {
                bagTypes[bt.name] = bt;
                if (bt.name !== 'Rejected') allTypeNames.push(bt.name);
            });
            if (bagTypes['Rejected']) allTypeNames.push('Rejected');
        }
    } catch(e) { console.warn('Failed to load bag types', e); }

    buildClassCards();

    // Fetch initial state
    try {
        const resp = await fetch('/api/counts');
        if (resp.ok) updateUI(await resp.json());
    } catch(e) {}

    connectSSE();
}
init();
</script>

</body>
</html>
