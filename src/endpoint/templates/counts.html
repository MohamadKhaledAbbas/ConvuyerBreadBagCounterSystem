<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Counts ‚Äî Conveyor Counter</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/analytics.css?v=5">
    <style>
        /* ‚îÄ‚îÄ Overrides & additions on top of analytics.css ‚îÄ‚îÄ */
        main { padding-top: 1.5rem; }

        /* Page header with live badge */
        .page-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; flex-wrap:wrap; gap:12px }
        .page-header h1 { font-size:1.5rem; font-weight:700; color:var(--text-primary); margin:0 }
        .status-badge { display:inline-flex; align-items:center; gap:6px; padding:5px 14px; border-radius:20px; font-size:.78rem; font-weight:600; background:rgba(45,212,191,.12); color:#2dd4bf; border:1px solid rgba(45,212,191,.25) }
        .status-badge .dot { width:8px; height:8px; border-radius:50%; background:#2dd4bf; animation:pulse 2s infinite }
        .status-badge.disconnected { background:rgba(248,113,113,.12); color:#f87171; border-color:rgba(248,113,113,.25) }
        .status-badge.disconnected .dot { background:#f87171; animation:none }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

        /* Hero card additions for live counts */
        .hero-card { grid-template-columns: 1fr 1fr 1fr; }
        @media(max-width:768px) { .hero-card { grid-template-columns:1fr; } }

        /* Stacked bar inside class cards */
        .count-bar { display:flex; height:8px; border-radius:4px; overflow:hidden; margin:0.6rem 0 0.3rem; background:rgba(255,255,255,.06) }
        .count-bar .seg-confirmed { background:#2dd4bf; transition:width .5s ease }
        .count-bar .seg-pending { background:#38bdf8; transition:width .5s ease }
        .count-bar .seg-classified { background:#fbbf24; transition:width .5s ease }

        .count-breakdown { display:flex; gap:0.75rem; margin:0.6rem 0 0.2rem; padding:0.6rem; background:rgba(15,23,42,.4); border-radius:var(--radius-md); justify-content:space-around }
        .cb-item { display:flex; flex-direction:column; align-items:center; gap:0.15rem }
        .cb-label { font-size:.6rem; font-weight:700; text-transform:uppercase; letter-spacing:.08em; opacity:.85 }
        .cb-value { font-size:1.2rem; font-weight:700 }
        .cb-item.confirmed .cb-label, .cb-item.confirmed .cb-value { color:#2dd4bf }
        .cb-item.pending .cb-label, .cb-item.pending .cb-value { color:#38bdf8 }
        .cb-item.classified .cb-label, .cb-item.classified .cb-value { color:#fbbf24 }

        /* Current batch section */
        .batch-section { margin-top:2rem }
        .batch-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; flex-wrap:wrap; gap:0.5rem }
        .batch-title { font-size:1.2rem; font-weight:700; color:var(--text-primary); display:flex; align-items:center; gap:0.5rem }
        .batch-title .live-dot { width:10px; height:10px; border-radius:50%; background:#2dd4bf; display:inline-block; animation:pulse 1.5s infinite }
        .batch-meta { font-size:.85rem; color:var(--text-secondary) }

        /* Window progress (inside batch) */
        .window-bar { margin-bottom:1rem; padding:12px 20px; background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius-md) }
        .window-meta { display:flex; justify-content:space-between; font-size:.8rem; margin-bottom:6px }
        .window-meta .wlabel { color:var(--text-muted) }
        .window-meta .wvalue { color:#38bdf8; font-weight:700 }
        .window-track { height:6px; background:rgba(255,255,255,.06); border-radius:3px; overflow:hidden }
        .window-fill { height:100%; background:linear-gradient(90deg,#38bdf8,#2dd4bf); border-radius:3px; transition:width .5s ease }

        /* Batch item cards */
        .batch-grid { display:flex; flex-direction:column; gap:0.8rem }
        .batch-item { display:flex; align-items:center; gap:1rem; padding:1rem 1.25rem; background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius-md); transition:all .3s }
        .batch-item:hover { border-color:#38bdf8; background:rgba(30,41,59,.9) }
        .batch-item .b-thumb { width:52px; height:52px; border-radius:var(--radius-md); overflow:hidden; flex-shrink:0; position:relative; background:#0f172a }
        .batch-item .b-thumb img { width:100%; height:100%; object-fit:cover }
        .batch-item.is-pending .b-thumb img { filter:grayscale(50%) brightness(.75) }
        .batch-item.is-pending .b-thumb::after { content:'‚è≥'; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:1.1rem; background:rgba(15,23,42,.4) }
        .batch-item .b-info { flex:1; min-width:0 }
        .batch-item .b-name { font-size:.95rem; font-weight:600; color:var(--text-primary) }
        .batch-item .b-status { font-size:.75rem; margin-top:2px }
        .batch-item.is-confirmed .b-thumb { border:2px solid #2dd4bf }
        .batch-item.is-confirmed .b-status { color:#2dd4bf }
        .batch-item.is-pending .b-thumb { border:2px solid rgba(56,189,248,.4) }
        .batch-item.is-pending .b-status { color:#38bdf8 }
        .batch-item .b-status .st-pending { color:#38bdf8 }
        .batch-item .b-status .st-classified { color:#fbbf24 }
        .batch-item .b-count { font-size:1.3rem; font-weight:700; flex-shrink:0 }
        .batch-item.is-confirmed .b-count { color:#2dd4bf }
        .batch-item.is-pending .b-count { color:#38bdf8 }

        /* Live feed panel */
        .feed-panel { background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius-lg); padding:1.25rem; max-height:500px; display:flex; flex-direction:column; margin-top:2rem }
        .feed-scroll { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:6px; padding-right:4px }
        .feed-scroll::-webkit-scrollbar { width:4px }
        .feed-scroll::-webkit-scrollbar-thumb { background:#38bdf8; border-radius:2px }
        .feed-item { padding:10px 12px; border-radius:var(--radius-md); background:rgba(15,23,42,.5); border-left:3px solid var(--text-muted); font-size:.78rem; line-height:1.5; animation:feedIn .3s ease; display:flex; gap:10px; align-items:flex-start }
        .feed-item.confirmed { border-left-color:#2dd4bf; background:rgba(45,212,191,.06) }
        .feed-item.tentative { border-left-color:#fbbf24; background:rgba(251,191,36,.05) }
        .feed-item.smoothed { border-left-color:#a78bfa; background:rgba(167,139,250,.06) }
        .feed-item.rejected { border-left-color:#f87171; background:rgba(248,113,113,.05) }
        .feed-time { color:var(--text-muted); font-variant-numeric:tabular-nums; white-space:nowrap; font-size:.72rem; margin-top:1px }
        .feed-msg { color:var(--text-secondary); word-break:break-word; flex:1 }
        .feed-msg strong { color:var(--text-primary); font-weight:600 }
        @keyframes feedIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }

        /* Two-column for batch + feed */
        .bottom-grid { display:grid; grid-template-columns:1fr 380px; gap:1.5rem; align-items:start }
        @media(max-width:960px) { .bottom-grid { grid-template-columns:1fr } }

        /* Stats footer */
        .stats-row { display:flex; gap:20px; flex-wrap:wrap; padding:14px 20px; background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius-md); font-size:.82rem; margin-top:1.5rem }
        .stat-pair { display:flex; gap:6px; align-items:center }
        .stat-pair .slabel { color:var(--text-muted) }
        .stat-pair .sval { color:#38bdf8; font-weight:700 }

        /* Section separator */
        .section-label { font-size:.8rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--text-muted); margin-bottom:12px; display:flex; align-items:center; gap:8px }

        /* Animations */
        @keyframes countBump { 0%{transform:scale(1)} 50%{transform:scale(1.12)} 100%{transform:scale(1)} }
        .bump { animation:countBump .3s ease }
        @keyframes confirmFlash { 0%{box-shadow:0 0 0 0 rgba(45,212,191,.5)} 100%{box-shadow:0 0 0 12px rgba(45,212,191,0)} }
        .confirm-flash { animation:confirmFlash .6s ease }

        .empty { color:var(--text-muted); font-size:.85rem; padding:16px 0; font-style:italic }
    </style>
</head>
<body>

<main>
    <!-- Header -->
    <div class="page-header">
        <h1>üìä Live Pipeline Counts</h1>
        <div class="status-badge" id="statusBadge">
            <span class="dot"></span>
            <span id="statusText">Connecting‚Ä¶</span>
        </div>
    </div>

    <!-- Hero section ‚Äî Total overview like analytics -->
    <section class="hero-section">
        <div class="hero-card">
            <div class="hero-metric primary">
                <div class="hero-label">Total Bags (All Stages)</div>
                <div class="hero-value" id="heroTotal">0</div>
                <div class="hero-breakdown">
                    <span class="tier-badge high-tier" id="heroConfirmedBadge">Confirmed: 0</span>
                    <span class="tier-badge low-tier" id="heroPendingBadge">Pending: 0</span>
                </div>
            </div>
            <div class="hero-metric">
                <div class="hero-label">Confirmed</div>
                <div class="hero-value" id="heroConfirmed" style="color:#2dd4bf">0</div>
            </div>
            <div class="hero-metric">
                <div class="hero-label">In Pipeline</div>
                <div class="hero-value" id="heroPipeline" style="color:#38bdf8">0</div>
            </div>
        </div>
    </section>

    <!-- Classification cards ‚Äî analytics style with live counts -->
    <div class="section-label">Per-Class Breakdown</div>
    <section class="grid-container" id="classGrid">
        <div class="empty" id="classGridEmpty">Waiting for data‚Ä¶</div>
    </section>

    <!-- Bottom: Current Batch + Live Feed -->
    <div class="bottom-grid">
        <!-- Current Batch -->
        <div class="batch-section">
            <div class="batch-header">
                <div class="batch-title"><span class="live-dot"></span> Current Batch</div>
                <div class="batch-meta" id="batchMeta">Smoothing window: 0 / 7</div>
            </div>

            <div class="window-bar">
                <div class="window-meta">
                    <span class="wlabel">Smoothing Progress</span>
                    <span class="wvalue" id="windowLabel">0 / 7 ‚Äî next in 7 items</span>
                </div>
                <div class="window-track">
                    <div class="window-fill" id="windowFill" style="width:0%"></div>
                </div>
            </div>

            <div class="batch-grid" id="batchGrid">
                <div class="empty" id="batchEmpty">No items in current batch</div>
            </div>
        </div>

        <!-- Live Event Feed -->
        <div>
            <div class="feed-panel">
                <div class="section-label" style="margin-bottom:10px">üì° Live Event Feed</div>
                <div class="feed-scroll" id="feedScroll">
                    <div class="empty">Waiting for events‚Ä¶</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats footer -->
    <div class="stats-row">
        <div class="stat-pair"><span class="slabel">Smoothing Rate:</span><span class="sval" id="smoothRate">0%</span></div>
        <div class="stat-pair"><span class="slabel">Window Size:</span><span class="sval" id="windowSize">7</span></div>
        <div class="stat-pair" id="lastUpdate" style="margin-left:auto;color:var(--text-muted)">‚Äî</div>
    </div>
</main>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let bagTypes = {};
let prevState = {};
let prevConfirmed = {};
let isFirstRender = true;
let seenEventCount = 0;

const $id = id => document.getElementById(id);

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function bump(el) {
    el.classList.remove('bump');
    void el.offsetWidth;
    el.classList.add('bump');
}

function confirmFlash(el) {
    el.classList.remove('confirm-flash');
    void el.offsetWidth;
    el.classList.add('confirm-flash');
}

function thumbUrl(className) {
    const bt = bagTypes[className];
    if (bt && bt.thumb) return '/' + bt.thumb;
    const letter = className ? className.charAt(0) : '?';
    return 'https://placehold.co/100x100/1e293b/FFF?text=' + encodeURIComponent(letter);
}

function imgTag(className) {
    const safe = (className || '?').charAt(0);
    return '<img src="' + thumbUrl(className) + '" alt="' + className + '" loading="lazy" onerror="this.src=\'https://placehold.co/100x100/1e293b/FFF?text=' + encodeURIComponent(safe) + '\'">';
}

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// ‚îÄ‚îÄ Render analytics-style class cards ‚îÄ‚îÄ
function renderClassCards(confirmed, pending, justClassified) {
    const grid = $id('classGrid');
    const empty = $id('classGridEmpty');

    // Merge all class names
    const allClasses = new Set([
        ...Object.keys(confirmed || {}),
        ...Object.keys(pending || {}),
        ...Object.keys(justClassified || {})
    ]);

    if (allClasses.size === 0) {
        empty.style.display = '';
        Array.from(grid.querySelectorAll('.stat-card')).forEach(c => c.remove());
        return;
    }
    empty.style.display = 'none';

    // Sort by total count descending
    const sorted = [...allClasses].map(name => ({
        name,
        conf: (confirmed || {})[name] || 0,
        pend: (pending || {})[name] || 0,
        cls:  (justClassified || {})[name] || 0
    })).sort((a, b) => (b.conf + b.pend + b.cls) - (a.conf + a.pend + a.cls));

    const existing = {};
    grid.querySelectorAll('.stat-card').forEach(card => { existing[card.dataset.cls] = card; });

    sorted.forEach(item => {
        const total = item.conf + item.pend + item.cls;
        let card = existing[item.name];
        const wasConfirmed = prevConfirmed[item.name] || 0;
        const justConfirmedMore = !isFirstRender && item.conf > wasConfirmed;

        if (!card) {
            card = document.createElement('div');
            card.className = 'stat-card';
            card.dataset.cls = item.name;
            card.innerHTML =
                '<div class="card-header stacked">' +
                    '<div class="card-title">' + escHtml(item.name) + '</div>' +
                    '<div class="thumb-container">' + imgTag(item.name) + '</div>' +
                '</div>' +
                '<div class="card-metric-large" data-role="total">' + total + '</div>' +
                '<div class="count-bar">' +
                    '<div class="seg-confirmed" data-role="bar-c" style="width:0%"></div>' +
                    '<div class="seg-pending" data-role="bar-p" style="width:0%"></div>' +
                    '<div class="seg-classified" data-role="bar-j" style="width:0%"></div>' +
                '</div>' +
                '<div class="count-breakdown">' +
                    '<div class="cb-item confirmed"><span class="cb-label">Confirmed</span><span class="cb-value" data-role="cv-c">' + item.conf + '</span></div>' +
                    '<div class="cb-item pending"><span class="cb-label">Pending</span><span class="cb-value" data-role="cv-p">' + item.pend + '</span></div>' +
                    '<div class="cb-item classified"><span class="cb-label">Classified</span><span class="cb-value" data-role="cv-j">' + item.cls + '</span></div>' +
                '</div>';
            grid.appendChild(card);
        } else {
            // Update existing
            const totalEl = card.querySelector('[data-role="total"]');
            const cvC = card.querySelector('[data-role="cv-c"]');
            const cvP = card.querySelector('[data-role="cv-p"]');
            const cvJ = card.querySelector('[data-role="cv-j"]');

            if (totalEl.textContent !== String(total)) { totalEl.textContent = total; bump(totalEl); }
            if (cvC.textContent !== String(item.conf)) { cvC.textContent = item.conf; bump(cvC); }
            if (cvP.textContent !== String(item.pend)) { cvP.textContent = item.pend; }
            if (cvJ.textContent !== String(item.cls))  { cvJ.textContent = item.cls;  }
        }

        // Update bar widths
        if (total > 0) {
            card.querySelector('[data-role="bar-c"]').style.width = (item.conf / total * 100) + '%';
            card.querySelector('[data-role="bar-p"]').style.width = (item.pend / total * 100) + '%';
            card.querySelector('[data-role="bar-j"]').style.width = (item.cls / total * 100) + '%';
        }

        // Flash on confirmation increase
        if (justConfirmedMore) { confirmFlash(card); }

        delete existing[item.name];
    });

    Object.values(existing).forEach(c => c.remove());
}

// ‚îÄ‚îÄ Render current batch items ‚îÄ‚îÄ
function renderBatch(pending, justClassified) {
    const grid = $id('batchGrid');
    const empty = $id('batchEmpty');

    // Merge pending + justClassified for the batch view
    const allNames = new Set([
        ...Object.keys(pending || {}),
        ...Object.keys(justClassified || {})
    ]);

    if (allNames.size === 0) {
        empty.style.display = '';
        Array.from(grid.querySelectorAll('.batch-item')).forEach(c => c.remove());
        return;
    }
    empty.style.display = 'none';

    const items = [...allNames].map(name => ({
        name,
        pend: (pending || {})[name] || 0,
        cls: (justClassified || {})[name] || 0
    })).sort((a, b) => (b.pend + b.cls) - (a.pend + a.cls));

    const existing = {};
    grid.querySelectorAll('.batch-item').forEach(card => { existing[card.dataset.cls] = card; });

    items.forEach(item => {
        let card = existing[item.name];
        if (!card) {
            card = document.createElement('div');
            card.dataset.cls = item.name;
            grid.appendChild(card);
        }

        const isPending = item.pend > 0;
        const isClassified = item.cls > 0 && item.pend === 0;
        card.className = 'batch-item' + (isPending ? ' is-pending' : ' is-confirmed');

        let statusHtml = '';
        if (item.pend > 0 && item.cls > 0) {
            statusHtml = '<span class="st-pending">' + item.pend + ' in smoothing</span> ¬∑ <span class="st-classified">' + item.cls + ' waiting</span>';
        } else if (item.pend > 0) {
            statusHtml = '<span class="st-pending">' + item.pend + ' in smoothing window ‚Äî not yet confirmed</span>';
        } else {
            statusHtml = '<span class="st-classified">' + item.cls + ' classified ‚Äî waiting for smoothing</span>';
        }

        card.innerHTML =
            '<div class="b-thumb">' + imgTag(item.name) + '</div>' +
            '<div class="b-info">' +
                '<div class="b-name">' + escHtml(item.name) + '</div>' +
                '<div class="b-status">' + statusHtml + '</div>' +
            '</div>' +
            '<div class="b-count">' + (item.pend + item.cls) + '</div>';

        delete existing[item.name];
    });

    Object.values(existing).forEach(c => c.remove());
}

// ‚îÄ‚îÄ Render feed ‚îÄ‚îÄ
function renderFeed(events) {
    const feedScroll = $id('feedScroll');
    if (!events || events.length === 0) return;

    const newEvents = events.slice(seenEventCount);
    if (newEvents.length === 0) return;
    seenEventCount = events.length;

    const emptyEl = feedScroll.querySelector('.empty');
    if (emptyEl) emptyEl.remove();

    newEvents.forEach(ev => {
        const div = document.createElement('div');
        const msg = ev.msg || '';
        let type = '';
        if (msg.includes('CONFIRMED')) type = 'confirmed';
        else if (msg.includes('TENTATIVE')) type = 'tentative';
        else if (msg.includes('SMOOTHED') || msg.includes('was ')) type = 'smoothed';
        else if (msg.includes('REJECTED') || msg.includes('UNRELIABLE')) type = 'rejected';

        div.className = 'feed-item' + (type ? ' ' + type : '');

        const t = ev.ts ? new Date(ev.ts * 1000) : new Date();
        const timeStr = t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});

        let display = msg.replace(/(T\d+)/g, '<strong>$1</strong>');
        const classNames = Object.keys(bagTypes);
        if (classNames.length > 0) {
            const classPattern = new RegExp('(' + classNames.map(n => n.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|') + ')', 'g');
            display = display.replace(classPattern, '<strong>$1</strong>');
        }

        div.innerHTML = '<span class="feed-time">' + timeStr + '</span><span class="feed-msg">' + display + '</span>';
        feedScroll.appendChild(div);
    });

    while (feedScroll.children.length > 30) {
        feedScroll.removeChild(feedScroll.firstChild);
    }
    feedScroll.scrollTop = feedScroll.scrollHeight;
}

// ‚îÄ‚îÄ Main UI update ‚îÄ‚îÄ
function updateUI(data) {
    const ct = data.confirmed_total || 0;
    const pt = data.pending_total || 0;
    const jt = data.just_classified_total || 0;
    const grandTotal = ct + pt + jt;

    // Hero
    const heroTotal = $id('heroTotal');
    const heroConfirmed = $id('heroConfirmed');
    const heroPipeline = $id('heroPipeline');
    if (heroTotal.textContent !== String(grandTotal)) { heroTotal.textContent = grandTotal; bump(heroTotal); }
    if (heroConfirmed.textContent !== String(ct)) { heroConfirmed.textContent = ct; bump(heroConfirmed); }
    const pipelineCount = pt + jt;
    if (heroPipeline.textContent !== String(pipelineCount)) { heroPipeline.textContent = pipelineCount; bump(heroPipeline); }

    $id('heroConfirmedBadge').textContent = 'Confirmed: ' + ct;
    $id('heroPendingBadge').textContent = 'In Pipeline: ' + pipelineCount;

    // Window progress
    const ws = data.window_status || {};
    const sz = ws.size || 7;
    const cur = ws.current_items || 0;
    const next = ws.next_confirmation_in || sz;
    $id('windowFill').style.width = Math.round((cur / sz) * 100) + '%';
    $id('windowLabel').textContent = cur + ' / ' + sz + ' ‚Äî next in ' + next + ' item' + (next !== 1 ? 's' : '');
    $id('windowSize').textContent = sz;
    $id('batchMeta').textContent = 'Smoothing window: ' + cur + ' / ' + sz;

    // Class cards (analytics style)
    renderClassCards(data.confirmed, data.pending, data.just_classified);

    // Current batch
    renderBatch(data.pending, data.just_classified);

    // Feed
    renderFeed(data.recent_events);

    // Stats
    $id('smoothRate').textContent = ((data.smoothing_rate || 0) * 100).toFixed(1) + '%';
    $id('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();

    // Track previous confirmed for flash animation
    prevConfirmed = Object.assign({}, data.confirmed || {});
    isFirstRender = false;
    prevState = data;
}

// ‚îÄ‚îÄ SSE ‚îÄ‚îÄ
function connectSSE() {
    const es = new EventSource('/api/counts/stream');
    es.onopen = () => {
        $id('statusBadge').className = 'status-badge';
        $id('statusText').textContent = 'Connected (live)';
    };
    es.onmessage = (e) => {
        try { updateUI(JSON.parse(e.data)); } catch(err) { console.warn('SSE parse error', err); }
    };
    es.onerror = () => {
        $id('statusBadge').className = 'status-badge disconnected';
        $id('statusText').textContent = 'Reconnecting‚Ä¶';
        es.close();
        setTimeout(connectSSE, 3000);
    };
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
    try {
        const resp = await fetch('/api/bag-types');
        if (resp.ok) {
            const types = await resp.json();
            types.forEach(bt => { bagTypes[bt.name] = bt; });
        }
    } catch(e) { console.warn('Failed to load bag types', e); }

    try {
        const resp = await fetch('/api/counts');
        if (resp.ok) updateUI(await resp.json());
    } catch(e) {}

    connectSSE();
}
init();
</script>

</body>
</html>
