<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Counts ‚Äî Conveyor Counter</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255,255,255,0.08);
            --glass-hover: rgba(30, 41, 59, 0.9);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #38bdf8;
            --green: #2dd4bf;
            --green-glow: rgba(45,212,191,0.15);
            --amber: #fbbf24;
            --amber-glow: rgba(251,191,36,0.12);
            --red: #f87171;
            --radius: 16px;
            --radius-sm: 10px;
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg-deep);color:var(--text-primary);min-height:100vh}
        .container{max-width:1300px;margin:0 auto;padding:24px 20px 48px}

        /* Header */
        .page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px}
        .page-header h1{font-size:1.5rem;font-weight:700;display:flex;align-items:center;gap:8px}
        .status-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;font-size:.78rem;font-weight:600;background:rgba(45,212,191,.12);color:var(--green);border:1px solid rgba(45,212,191,.25)}
        .status-badge .dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
        .status-badge.disconnected{background:rgba(248,113,113,.12);color:var(--red);border-color:rgba(248,113,113,.25)}
        .status-badge.disconnected .dot{background:var(--red);animation:none}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

        /* Pipeline bar */
        .pipeline-bar{display:flex;align-items:stretch;background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:var(--radius);overflow:hidden;margin-bottom:24px}
        .pipe-stage{flex:1;text-align:center;padding:16px 12px;position:relative;transition:background .3s}
        .pipe-stage:not(:last-child)::after{content:'';position:absolute;right:0;top:20%;height:60%;width:1px;background:var(--glass-border)}
        .pipe-stage:hover{background:rgba(255,255,255,.03)}
        .pipe-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted);margin-bottom:4px;font-weight:600}
        .pipe-count{font-size:1.6rem;font-weight:800;transition:color .3s}
        .pipe-stage.classified .pipe-count{color:var(--amber)}
        .pipe-stage.pending .pipe-count{color:var(--accent)}
        .pipe-stage.confirmed .pipe-count{color:var(--green)}
        .pipe-arrow{display:flex;align-items:center;color:var(--text-muted);font-size:1.1rem;padding:0 2px;flex-shrink:0}

        /* Window progress */
        .window-bar{margin-bottom:28px;padding:12px 20px;background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:var(--radius-sm)}
        .window-meta{display:flex;justify-content:space-between;font-size:.8rem;margin-bottom:6px}
        .window-meta .label{color:var(--text-muted)}
        .window-meta .value{color:var(--accent);font-weight:700}
        .window-track{height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden}
        .window-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:3px;transition:width .5s ease}

        /* Two-column layout */
        .main-grid{display:grid;grid-template-columns:1fr 380px;gap:24px;align-items:start}
        @media(max-width:960px){.main-grid{grid-template-columns:1fr}}

        /* Section titles */
        .section-title{font-size:.85rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--text-muted);margin-bottom:14px;display:flex;align-items:center;gap:8px}

        /* ===== Confirmed Class Cards ===== */
        .class-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-bottom:28px}
        .class-card{background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:var(--radius);padding:14px;display:flex;flex-direction:column;align-items:center;transition:all .25s;position:relative;overflow:hidden}
        .class-card:hover{border-color:var(--green);transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
        .class-card .thumb{width:80px;height:80px;border-radius:12px;overflow:hidden;border:2px solid var(--green);margin-bottom:10px;flex-shrink:0;position:relative;background:#1e293b}
        .class-card .thumb img{width:100%;height:100%;object-fit:cover}
        .class-card .name{font-size:.82rem;color:var(--text-secondary);margin-bottom:6px;text-align:center;font-weight:500}
        .class-card .count-value{font-size:1.8rem;font-weight:800;color:var(--green)}
        .class-card .confirmed-badge{position:absolute;top:8px;right:8px;background:rgba(45,212,191,.2);color:var(--green);font-size:.6rem;font-weight:700;padding:2px 8px;border-radius:10px;text-transform:uppercase;letter-spacing:.05em}

        /* ===== Pending Class Cards ===== */
        .pending-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:28px}
        .pending-card{background:var(--glass-bg);border:1px solid rgba(56,189,248,.2);border-radius:var(--radius-sm);padding:12px;display:flex;align-items:center;gap:12px;transition:all .25s}
        .pending-card:hover{border-color:var(--accent)}
        .pending-card .thumb{width:48px;height:48px;border-radius:10px;overflow:hidden;border:2px solid rgba(56,189,248,.3);flex-shrink:0;position:relative;background:#1e293b}
        .pending-card .thumb img{width:100%;height:100%;object-fit:cover;filter:grayscale(60%) brightness(.7);transition:filter .3s}
        .pending-card:hover .thumb img{filter:grayscale(30%) brightness(.85)}
        .pending-card .thumb::after{content:'‚è≥';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:1rem;background:rgba(15,23,42,.45)}
        .pending-card .info{flex:1;min-width:0}
        .pending-card .name{font-size:.78rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .pending-card .count-value{font-size:1.15rem;font-weight:700;color:var(--accent)}

        /* Classified (tentative) section */
        .classified-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:28px}
        .classified-card{background:var(--glass-bg);border:1px solid rgba(251,191,36,.15);border-radius:var(--radius-sm);padding:12px;display:flex;align-items:center;gap:12px;transition:all .25s}
        .classified-card:hover{border-color:var(--amber)}
        .classified-card .thumb{width:48px;height:48px;border-radius:10px;overflow:hidden;border:2px solid rgba(251,191,36,.25);flex-shrink:0;position:relative;background:#1e293b}
        .classified-card .thumb img{width:100%;height:100%;object-fit:cover;filter:grayscale(80%) brightness(.55);transition:filter .3s}
        .classified-card:hover .thumb img{filter:grayscale(50%) brightness(.7)}
        .classified-card .thumb::after{content:'‚ö°';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:1rem;background:rgba(15,23,42,.5)}
        .classified-card .info{flex:1;min-width:0}
        .classified-card .name{font-size:.78rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .classified-card .count-value{font-size:1.15rem;font-weight:700;color:var(--amber)}

        /* Empty state */
        .empty{color:var(--text-muted);font-size:.85rem;padding:16px 0;font-style:italic}

        /* ===== Live Event Feed ===== */
        .feed-panel{background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:var(--radius);padding:16px;max-height:620px;display:flex;flex-direction:column}
        .feed-scroll{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:6px;padding-right:4px}
        .feed-scroll::-webkit-scrollbar{width:4px}
        .feed-scroll::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px}
        .feed-item{padding:10px 12px;border-radius:var(--radius-sm);background:rgba(15,23,42,.5);border-left:3px solid var(--text-muted);font-size:.78rem;line-height:1.5;animation:feedIn .3s ease;display:flex;gap:10px;align-items:flex-start}
        .feed-item.confirmed{border-left-color:var(--green);background:rgba(45,212,191,.06)}
        .feed-item.tentative{border-left-color:var(--amber);background:rgba(251,191,36,.05)}
        .feed-item.smoothed{border-left-color:#a78bfa;background:rgba(167,139,250,.06)}
        .feed-item.rejected{border-left-color:var(--red);background:rgba(248,113,113,.05)}
        .feed-time{color:var(--text-muted);font-variant-numeric:tabular-nums;white-space:nowrap;font-size:.72rem;margin-top:1px}
        .feed-msg{color:var(--text-secondary);word-break:break-word;flex:1}
        .feed-msg strong{color:var(--text-primary);font-weight:600}
        @keyframes feedIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

        /* Stats bar */
        .stats-row{display:flex;gap:20px;flex-wrap:wrap;padding:14px 20px;background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:var(--radius-sm);font-size:.82rem;margin-top:8px}
        .stat{display:flex;gap:6px;align-items:center}
        .stat .label{color:var(--text-muted)}
        .stat .val{color:var(--accent);font-weight:700}
        .stat .updated{color:var(--text-muted);margin-left:auto}

        /* Animations */
        @keyframes countBump{0%{transform:scale(1)}50%{transform:scale(1.12)}100%{transform:scale(1)}}
        .bump{animation:countBump .3s ease}

        @media(max-width:720px){
            .pipeline-bar{flex-wrap:wrap}
            .pipe-arrow{display:none}
            .class-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="page-header">
        <h1>üìä Live Pipeline Counts</h1>
        <div class="status-badge" id="statusBadge">
            <span class="dot"></span>
            <span id="statusText">Connecting‚Ä¶</span>
        </div>
    </div>

    <!-- Pipeline flow bar -->
    <div class="pipeline-bar">
        <div class="pipe-stage classified">
            <div class="pipe-label">‚ö° Classified</div>
            <div class="pipe-count" id="pipeClassified">0</div>
        </div>
        <div class="pipe-arrow">‚Üí</div>
        <div class="pipe-stage pending">
            <div class="pipe-label">üîÑ Smoothing</div>
            <div class="pipe-count" id="pipePending">0</div>
        </div>
        <div class="pipe-arrow">‚Üí</div>
        <div class="pipe-stage confirmed">
            <div class="pipe-label">‚úì Confirmed</div>
            <div class="pipe-count" id="pipeConfirmed">0</div>
        </div>
    </div>

    <!-- Smoothing window progress -->
    <div class="window-bar">
        <div class="window-meta">
            <span class="label">Smoothing Window</span>
            <span class="value" id="windowLabel">0 / 7 ‚Äî next in 7</span>
        </div>
        <div class="window-track">
            <div class="window-fill" id="windowFill" style="width:0%"></div>
        </div>
    </div>

    <!-- Main two-column layout -->
    <div class="main-grid">
        <!-- Left: Count cards -->
        <div class="left-col">
            <!-- Confirmed counts -->
            <div class="section-title">‚úì Confirmed &amp; Persisted</div>
            <div class="class-grid" id="confirmedGrid">
                <div class="empty" id="confirmedEmpty">Waiting for confirmed counts‚Ä¶</div>
            </div>

            <!-- Pending counts -->
            <div class="section-title">‚è≥ Pending ‚Äî In Smoothing Window</div>
            <div class="pending-grid" id="pendingGrid">
                <div class="empty" id="pendingEmpty">No items pending</div>
            </div>

            <!-- Tentative / Just Classified -->
            <div class="section-title">‚ö° Just Classified ‚Äî Tentative</div>
            <div class="classified-grid" id="classifiedGrid">
                <div class="empty" id="classifiedEmpty">No recent classifications</div>
            </div>
        </div>

        <!-- Right: Live event feed -->
        <div class="right-col">
            <div class="feed-panel">
                <div class="section-title" style="margin-bottom:10px">üì° Live Event Feed</div>
                <div class="feed-scroll" id="feedScroll">
                    <div class="empty">Waiting for events‚Ä¶</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-row">
        <div class="stat"><span class="label">Smoothing Rate:</span><span class="val" id="smoothRate">0%</span></div>
        <div class="stat"><span class="label">Window Size:</span><span class="val" id="windowSize">7</span></div>
        <div class="stat updated" id="lastUpdate" style="margin-left:auto;color:var(--text-muted)">‚Äî</div>
    </div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let bagTypes = {};  // name ‚Üí {thumb, arabic_name, ...}
let prevState = {};
let seenEventCount = 0;

// ‚îÄ‚îÄ Elements ‚îÄ‚îÄ
const $id = id => document.getElementById(id);
const statusBadge = $id('statusBadge');
const statusText  = $id('statusText');
const pipeClassified = $id('pipeClassified');
const pipePending    = $id('pipePending');
const pipeConfirmed  = $id('pipeConfirmed');
const windowFillEl = $id('windowFill');
const windowLabel  = $id('windowLabel');
const confirmedGrid   = $id('confirmedGrid');
const pendingGrid     = $id('pendingGrid');
const classifiedGrid  = $id('classifiedGrid');
const confirmedEmpty  = $id('confirmedEmpty');
const pendingEmpty    = $id('pendingEmpty');
const classifiedEmpty = $id('classifiedEmpty');
const feedScroll   = $id('feedScroll');
const smoothRate   = $id('smoothRate');
const windowSizeEl = $id('windowSize');
const lastUpdate   = $id('lastUpdate');

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function bump(el) {
    el.classList.remove('bump');
    void el.offsetWidth;
    el.classList.add('bump');
}

function thumbUrl(className) {
    const bt = bagTypes[className];
    if (bt && bt.thumb) return '/' + bt.thumb;
    // Fallback placeholder
    const letter = className ? className.charAt(0) : '?';
    return 'https://placehold.co/100x100/1e293b/FFF?text=' + encodeURIComponent(letter);
}

function imgTag(className) {
    const safe = (className || '?').charAt(0);
    return '<img src="' + thumbUrl(className) + '" alt="' + className + '" loading="lazy" onerror="this.src=\'https://placehold.co/100x100/1e293b/FFF?text=' + encodeURIComponent(safe) + '\'">';
}

// ‚îÄ‚îÄ Render confirmed cards ‚îÄ‚îÄ
function renderConfirmed(counts) {
    if (!counts || Object.keys(counts).length === 0) {
        confirmedEmpty.style.display = '';
        Array.from(confirmedGrid.querySelectorAll('.class-card')).forEach(c => c.remove());
        return;
    }
    confirmedEmpty.style.display = 'none';
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const existing = {};
    confirmedGrid.querySelectorAll('.class-card').forEach(card => {
        existing[card.dataset.cls] = card;
    });

    sorted.forEach(([name, count]) => {
        let card = existing[name];
        if (!card) {
            card = document.createElement('div');
            card.className = 'class-card';
            card.dataset.cls = name;
            card.innerHTML =
                '<span class="confirmed-badge">confirmed</span>' +
                '<div class="thumb">' + imgTag(name) + '</div>' +
                '<div class="name">' + name + '</div>' +
                '<div class="count-value">' + count + '</div>';
            confirmedGrid.appendChild(card);
        } else {
            const cv = card.querySelector('.count-value');
            if (cv.textContent !== String(count)) {
                cv.textContent = count;
                bump(cv);
            }
        }
        delete existing[name];
    });
    Object.values(existing).forEach(c => c.remove());
}

// ‚îÄ‚îÄ Render pending cards ‚îÄ‚îÄ
function renderPending(counts) {
    if (!counts || Object.keys(counts).length === 0) {
        pendingEmpty.style.display = '';
        Array.from(pendingGrid.querySelectorAll('.pending-card')).forEach(c => c.remove());
        return;
    }
    pendingEmpty.style.display = 'none';
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const existing = {};
    pendingGrid.querySelectorAll('.pending-card').forEach(card => {
        existing[card.dataset.cls] = card;
    });

    sorted.forEach(([name, count]) => {
        let card = existing[name];
        if (!card) {
            card = document.createElement('div');
            card.className = 'pending-card';
            card.dataset.cls = name;
            card.innerHTML =
                '<div class="thumb">' + imgTag(name) + '</div>' +
                '<div class="info">' +
                    '<div class="name">' + name + '</div>' +
                    '<div class="count-value">' + count + '</div>' +
                '</div>';
            pendingGrid.appendChild(card);
        } else {
            const cv = card.querySelector('.count-value');
            if (cv.textContent !== String(count)) {
                cv.textContent = count;
                bump(cv);
            }
        }
        delete existing[name];
    });
    Object.values(existing).forEach(c => c.remove());
}

// ‚îÄ‚îÄ Render classified cards ‚îÄ‚îÄ
function renderClassified(counts) {
    if (!counts || Object.keys(counts).length === 0) {
        classifiedEmpty.style.display = '';
        Array.from(classifiedGrid.querySelectorAll('.classified-card')).forEach(c => c.remove());
        return;
    }
    classifiedEmpty.style.display = 'none';
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const existing = {};
    classifiedGrid.querySelectorAll('.classified-card').forEach(card => {
        existing[card.dataset.cls] = card;
    });

    sorted.forEach(([name, count]) => {
        let card = existing[name];
        if (!card) {
            card = document.createElement('div');
            card.className = 'classified-card';
            card.dataset.cls = name;
            card.innerHTML =
                '<div class="thumb">' + imgTag(name) + '</div>' +
                '<div class="info">' +
                    '<div class="name">' + name + '</div>' +
                    '<div class="count-value">' + count + '</div>' +
                '</div>';
            classifiedGrid.appendChild(card);
        } else {
            const cv = card.querySelector('.count-value');
            if (cv.textContent !== String(count)) {
                cv.textContent = count;
                bump(cv);
            }
        }
        delete existing[name];
    });
    Object.values(existing).forEach(c => c.remove());
}

// ‚îÄ‚îÄ Render feed ‚îÄ‚îÄ
function renderFeed(events) {
    if (!events || events.length === 0) return;

    // Only render new events
    const newEvents = events.slice(seenEventCount);
    if (newEvents.length === 0) return;
    seenEventCount = events.length;

    // Remove empty placeholder
    const emptyEl = feedScroll.querySelector('.empty');
    if (emptyEl) emptyEl.remove();

    newEvents.forEach(ev => {
        const div = document.createElement('div');
        const msg = ev.msg || '';
        // Determine type for styling
        let type = '';
        if (msg.includes('CONFIRMED')) type = 'confirmed';
        else if (msg.includes('TENTATIVE')) type = 'tentative';
        else if (msg.includes('SMOOTHED') || msg.includes('was ')) type = 'smoothed';
        else if (msg.includes('REJECTED') || msg.includes('UNRELIABLE')) type = 'rejected';

        div.className = 'feed-item' + (type ? ' ' + type : '');

        const t = ev.ts ? new Date(ev.ts * 1000) : new Date();
        const timeStr = t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});

        // Highlight track IDs and class names in the message
        let display = msg
            .replace(/(T\d+)/g, '<strong>$1</strong>')
            .replace(/(Brown_Orange|Red_Yellow|Wheatberry|Blue_Yellow|Green_Yellow|Bran|Black_Orange|Purple_Yellow|Rejected)/g, '<strong>$1</strong>');

        div.innerHTML = '<span class="feed-time">' + timeStr + '</span><span class="feed-msg">' + display + '</span>';
        feedScroll.appendChild(div);
    });

    // Keep max 30 entries
    while (feedScroll.children.length > 30) {
        feedScroll.removeChild(feedScroll.firstChild);
    }

    // Auto-scroll to bottom
    feedScroll.scrollTop = feedScroll.scrollHeight;
}

// ‚îÄ‚îÄ Main UI update ‚îÄ‚îÄ
function updateUI(data) {
    const ct = data.confirmed_total || 0;
    const pt = data.pending_total || 0;
    const jt = data.just_classified_total || 0;

    // Pipeline counts
    [pipeConfirmed, pipePending, pipeClassified].forEach((el, i) => {
        const val = [ct, pt, jt][i];
        if (el.textContent !== String(val)) { el.textContent = val; bump(el); }
    });

    // Window progress
    const ws = data.window_status || {};
    const sz = ws.size || 7;
    const cur = ws.current_items || 0;
    const next = ws.next_confirmation_in || sz;
    windowFillEl.style.width = Math.round((cur / sz) * 100) + '%';
    windowLabel.textContent = cur + ' / ' + sz + ' ‚Äî next in ' + next + ' item' + (next !== 1 ? 's' : '');
    windowSizeEl.textContent = sz;

    // Cards
    renderConfirmed(data.confirmed);
    renderPending(data.pending);
    renderClassified(data.just_classified);

    // Feed
    renderFeed(data.recent_events);

    // Stats
    smoothRate.textContent = ((data.smoothing_rate || 0) * 100).toFixed(1) + '%';
    lastUpdate.textContent = 'Updated ' + new Date().toLocaleTimeString();

    prevState = data;
}

// ‚îÄ‚îÄ SSE ‚îÄ‚îÄ
function connectSSE() {
    const es = new EventSource('/api/counts/stream');
    es.onopen = () => {
        statusBadge.className = 'status-badge';
        statusText.textContent = 'Connected (live)';
    };
    es.onmessage = (e) => {
        try { updateUI(JSON.parse(e.data)); } catch(err) { console.warn('SSE parse error', err); }
    };
    es.onerror = () => {
        statusBadge.className = 'status-badge disconnected';
        statusText.textContent = 'Reconnecting‚Ä¶';
        es.close();
        setTimeout(connectSSE, 3000);
    };
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
    // Load bag types for thumbnails
    try {
        const resp = await fetch('/api/bag-types');
        if (resp.ok) {
            const types = await resp.json();
            types.forEach(bt => { bagTypes[bt.name] = bt; });
        }
    } catch(e) { console.warn('Failed to load bag types', e); }

    // Initial data fetch
    try {
        const resp = await fetch('/api/counts');
        if (resp.ok) updateUI(await resp.json());
    } catch(e) {}

    connectSSE();
}
init();
</script>
</body>
</html>
