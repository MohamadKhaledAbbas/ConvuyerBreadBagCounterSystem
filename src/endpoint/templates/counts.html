<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Counts ‚Äî Conveyor Counter</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/analytics.css?v=6">
    <style>
        /* ‚îÄ‚îÄ Overrides on analytics.css ‚îÄ‚îÄ */
        main { padding-top: 1.5rem; }

        /* Header */
        .page-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; flex-wrap:wrap; gap:12px }
        .page-header h1 { font-size:1.5rem; font-weight:700; color:var(--text-primary); margin:0 }
        .status-badge { display:inline-flex; align-items:center; gap:6px; padding:5px 14px; border-radius:20px; font-size:.78rem; font-weight:600; background:rgba(45,212,191,.12); color:#2dd4bf; border:1px solid rgba(45,212,191,.25) }
        .status-badge .dot { width:8px; height:8px; border-radius:50%; background:#2dd4bf; animation:pulse 2s infinite }
        .status-badge.disconnected { background:rgba(248,113,113,.12); color:#f87171; border-color:rgba(248,113,113,.25) }
        .status-badge.disconnected .dot { background:#f87171; animation:none }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

        /* Hero with 3 cols */
        .hero-card { grid-template-columns: 1fr 1fr 1fr; }
        @media(max-width:768px) { .hero-card { grid-template-columns:1fr; } }

        /* Section label */
        .section-label { font-size:.8rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--text-muted); margin-bottom:12px; display:flex; align-items:center; gap:8px }

        /* ‚îÄ‚îÄ Processing card (the bridge) ‚îÄ‚îÄ */
        .processing-section { margin: 2rem 0 0; display:flex; flex-direction:column; align-items:center; gap:0 }

        .processing-card {
            background: rgba(30,41,59,.6);
            border: 1px dashed rgba(148,163,184,.3);
            border-radius: var(--radius-lg);
            padding: 1.5rem 2.5rem;
            text-align: center;
            position: relative;
            transition: all .4s ease;
            min-width: 260px;
        }
        .processing-card.has-items {
            border-color: rgba(56,189,248,.4);
            background: rgba(30,41,59,.75);
        }
        .processing-card .proc-icon {
            font-size: 2rem;
            margin-bottom: .5rem;
        }
        .processing-card .proc-count {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-muted);
            transition: color .3s;
            font-variant-numeric: tabular-nums;
        }
        .processing-card.has-items .proc-count { color: #94a3b8; }
        .processing-card .proc-label {
            font-size: .8rem;
            color: var(--text-muted);
            margin-top: .25rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .08em;
        }

        /* Spinner for processing */
        .spinner {
            display: inline-block;
            width: 20px; height: 20px;
            border: 2.5px solid rgba(148,163,184,.2);
            border-top-color: #38bdf8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 6px;
        }
        .spinner.hidden { display:none }
        @keyframes spin { to { transform:rotate(360deg) } }

        /* Connecting line */
        .connect-line {
            width: 2px;
            height: 40px;
            background: rgba(148,163,184,.15);
            position: relative;
            transition: background .4s;
        }
        .connect-line.active { background: rgba(56,189,248,.35) }
        .connect-line .line-dot {
            position: absolute;
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #38bdf8;
            left: 50%; top: 0;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity .3s;
        }
        .connect-line.active .line-dot {
            opacity: 1;
            animation: flowDown 1.2s ease-in-out infinite;
        }
        @keyframes flowDown {
            0% { top:0; opacity:0 }
            30% { opacity:1 }
            70% { opacity:1 }
            100% { top:calc(100% - 8px); opacity:0 }
        }

        /* Confirmed transition flash on line */
        @keyframes confirmPulse {
            0% { background: rgba(45,212,191,.6); box-shadow: 0 0 12px rgba(45,212,191,.4) }
            100% { background: rgba(148,163,184,.15); box-shadow: none }
        }
        .connect-line.confirm-pulse { animation: confirmPulse .8s ease; width: 3px }

        /* Card confirmed count */
        .card-metric-large { font-variant-numeric: tabular-nums; }

        /* Card batch sub-info */
        .card-batch-info { font-size:.72rem; color:var(--text-muted); margin-top:4px; font-variant-numeric:tabular-nums; display:flex; gap:8px; justify-content:center }
        .card-batch-info .confirmed-part { color:rgba(45,212,191,.7) }
        .card-batch-info .pending-part { color:rgba(148,163,184,.7) }

        /* Animations */
        @keyframes countBump { 0%{transform:scale(1)} 50%{transform:scale(1.12)} 100%{transform:scale(1)} }
        .bump { animation:countBump .3s ease }
        @keyframes confirmFlash { 0%{box-shadow:0 0 0 0 rgba(45,212,191,.5)} 100%{box-shadow:0 0 0 14px rgba(45,212,191,0)} }
        .confirm-flash { animation:confirmFlash .7s ease }

        /* Footer */
        .footer-row { display:flex; justify-content:flex-end; padding:12px 0; font-size:.78rem; color:var(--text-muted) }
    </style>
</head>
<body>

<main>
    <!-- Header -->
    <div class="page-header">
        <h1>üìä Live Counts</h1>
        <div class="status-badge" id="statusBadge">
            <span class="dot"></span>
            <span id="statusText">Connecting‚Ä¶</span>
        </div>
    </div>

    <!-- Hero ‚Äî Batch totals -->
    <section class="hero-section">
        <div class="hero-card">
            <div class="hero-metric primary">
                <div class="hero-label">Current Batch</div>
                <div class="hero-value" id="heroBatch" style="color:var(--text-primary)">0</div>
                <div class="hero-sub">Total counted (confirmed + pending)</div>
            </div>
            <div class="hero-metric">
                <div class="hero-label">Confirmed</div>
                <div class="hero-value" id="heroConfirmed" style="color:#2dd4bf">0</div>
                <div class="hero-sub" style="color:var(--text-muted)">Persisted</div>
            </div>
            <div class="hero-metric">
                <div class="hero-label">Processing</div>
                <div class="hero-value" id="heroPending" style="color:#94a3b8">0</div>
                <div class="hero-sub" style="color:var(--text-muted)">Not yet confirmed</div>
            </div>
        </div>
    </section>

    <!-- Processing bridge -->
    <div class="processing-section">
        <div class="processing-card" id="processingCard">
            <div class="proc-icon">üì¶</div>
            <div class="proc-count"><span id="procCountValue">0</span><span class="spinner hidden" id="procSpinner"></span></div>
            <div class="proc-label">Bags being processed</div>
        </div>
        <div class="connect-line" id="connectLine"><div class="line-dot"></div></div>
    </div>

    <!-- Confirmed class cards ‚Äî all types, analytics-style -->
    <div class="section-label">Counts by Type</div>
    <section class="grid-container" id="classGrid">
        <!-- Populated by JS on init -->
    </section>

    <!-- Footer -->
    <div class="footer-row"><span id="lastUpdate">‚Äî</span></div>
</main>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let bagTypes = {};
let allTypeNames = [];
let prevConfirmed = {};
let isFirstRender = true;

const $id = id => document.getElementById(id);

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function bump(el) {
    el.classList.remove('bump');
    void el.offsetWidth;
    el.classList.add('bump');
}

function confirmFlash(el) {
    el.classList.remove('confirm-flash');
    void el.offsetWidth;
    el.classList.add('confirm-flash');
}

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function thumbUrl(className) {
    const bt = bagTypes[className];
    if (bt && bt.thumb) return '/' + bt.thumb;
    const letter = className ? className.charAt(0) : '?';
    return 'https://placehold.co/170x170/1e293b/64748b?text=' + encodeURIComponent(letter);
}

function imgTag(className) {
    const safe = (className || '?').charAt(0);
    return '<img src="' + thumbUrl(className) + '" alt="' + escHtml(className) + '" loading="lazy" onerror="this.src=\'https://placehold.co/170x170/1e293b/64748b?text=' + encodeURIComponent(safe) + '\'">';
}

// ‚îÄ‚îÄ Build all type cards once (including zeros) ‚îÄ‚îÄ
function buildClassCards() {
    const grid = $id('classGrid');
    grid.innerHTML = '';

    // Sort: non-Rejected first alphabetically, Rejected last
    const sorted = [...allTypeNames].sort((a, b) => {
        if (a === 'Rejected') return 1;
        if (b === 'Rejected') return -1;
        return a.localeCompare(b);
    });

    sorted.forEach(name => {
        const card = document.createElement('div');
        card.className = 'stat-card';
        card.dataset.cls = name;
        card.innerHTML =
            '<div class="card-header stacked">' +
                '<div class="card-title">' + escHtml(name) + '</div>' +
                '<div class="thumb-container">' + imgTag(name) + '</div>' +
            '</div>' +
            '<div class="card-metric-large" data-role="count" style="color:#2dd4bf">0</div>' +
            '<div class="card-batch-info" data-role="batch-info"></div>';
        grid.appendChild(card);
    });
}

// ‚îÄ‚îÄ Update confirmed cards with batch counts ‚îÄ‚îÄ
function updateClassCards(confirmed, pending) {
    const grid = $id('classGrid');
    const cards = grid.querySelectorAll('.stat-card');

    cards.forEach(card => {
        const name = card.dataset.cls;
        const conf = (confirmed || {})[name] || 0;
        const pend = (pending || {})[name] || 0;
        const batch = conf + pend;
        const el = card.querySelector('[data-role="count"]');
        const infoEl = card.querySelector('[data-role="batch-info"]');
        const prev = parseInt(el.textContent) || 0;

        if (prev !== batch) {
            el.textContent = batch;
            if (!isFirstRender && batch > prev) {
                bump(el);
                confirmFlash(card);
            }
        }

        // Show breakdown only when there are items
        if (batch > 0 && pend > 0) {
            infoEl.innerHTML = '<span class="confirmed-part">‚úì ' + conf + ' confirmed</span>' +
                               '<span class="pending-part">‚è≥ +' + pend + ' pending</span>';
        } else if (batch > 0) {
            infoEl.innerHTML = '<span class="confirmed-part">‚úì ' + conf + ' confirmed</span>';
        } else {
            infoEl.innerHTML = '';
        }
    });
}

// ‚îÄ‚îÄ Update processing card ‚îÄ‚îÄ
function updateProcessing(pendingTotal) {
    const card = $id('processingCard');
    const countEl = $id('procCountValue');
    const spinner = $id('procSpinner');
    const line = $id('connectLine');

    const prev = parseInt(countEl.textContent) || 0;
    countEl.textContent = pendingTotal;

    if (pendingTotal > 0) {
        card.classList.add('has-items');
        spinner.classList.remove('hidden');
        line.classList.add('active');
    } else {
        card.classList.remove('has-items');
        spinner.classList.add('hidden');
        line.classList.remove('active');
    }

    if (!isFirstRender && prev > pendingTotal && pendingTotal >= 0) {
        // Items moved from processing ‚Üí confirmed
        line.classList.remove('confirm-pulse');
        void line.offsetWidth;
        line.classList.add('confirm-pulse');
    }

    if (prev !== pendingTotal) {
        bump(countEl);
    }
}

// ‚îÄ‚îÄ Main UI update ‚îÄ‚îÄ
function updateUI(data) {
    const ct = data.confirmed_total || 0;
    const pt = (data.pending_total || 0) + (data.just_classified_total || 0);
    const batchTotal = ct + pt;

    // Hero
    const heroBatch = $id('heroBatch');
    const heroConfirmed = $id('heroConfirmed');
    const heroPending = $id('heroPending');
    if (heroBatch.textContent !== String(batchTotal)) { heroBatch.textContent = batchTotal; bump(heroBatch); }
    if (heroConfirmed.textContent !== String(ct)) { heroConfirmed.textContent = ct; bump(heroConfirmed); }
    if (heroPending.textContent !== String(pt)) { heroPending.textContent = pt; bump(heroPending); }

    // Processing card
    updateProcessing(pt);

    // Merge pending + just_classified for per-class pending counts
    const allPending = {};
    for (const [cls, n] of Object.entries(data.pending || {})) { allPending[cls] = (allPending[cls] || 0) + n; }
    for (const [cls, n] of Object.entries(data.just_classified || {})) { allPending[cls] = (allPending[cls] || 0) + n; }

    // Confirmed type cards (with batch = confirmed + pending)
    updateClassCards(data.confirmed, allPending);

    // Footer
    $id('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();

    // Track state
    prevConfirmed = Object.assign({}, data.confirmed || {});
    isFirstRender = false;
}

// ‚îÄ‚îÄ SSE ‚îÄ‚îÄ
function connectSSE() {
    const es = new EventSource('/api/counts/stream');
    es.onopen = () => {
        $id('statusBadge').className = 'status-badge';
        $id('statusText').textContent = 'Connected';
    };
    es.onmessage = (e) => {
        try { updateUI(JSON.parse(e.data)); } catch(err) { console.warn('SSE parse error', err); }
    };
    es.onerror = () => {
        $id('statusBadge').className = 'status-badge disconnected';
        $id('statusText').textContent = 'Reconnecting‚Ä¶';
        es.close();
        setTimeout(connectSSE, 3000);
    };
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
    // Load bag types
    try {
        const resp = await fetch('/api/bag-types');
        if (resp.ok) {
            const types = await resp.json();
            types.forEach(bt => {
                bagTypes[bt.name] = bt;
                if (bt.name !== 'Rejected') allTypeNames.push(bt.name);
            });
            // Add Rejected last
            if (bagTypes['Rejected']) allTypeNames.push('Rejected');
        }
    } catch(e) { console.warn('Failed to load bag types', e); }

    // Build cards for all types
    buildClassCards();

    // Fetch initial state
    try {
        const resp = await fetch('/api/counts');
        if (resp.ok) updateUI(await resp.json());
    } catch(e) {}

    connectSSE();
}
init();
</script>

</body>
</html>
